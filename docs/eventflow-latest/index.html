

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>EventFlow 0.1 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  

  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  
        <link rel="index" title="Index"
              href="genindex.html"/>
        <link rel="search" title="Search" href="search.html"/>
    <link rel="top" title="None" href="index.html#document-index"/> 

  
  <script src="_static/js/modernizr.min.js"></script>


<!-- RTD Extra Head -->

<!-- 
Always link to the latest version, as canonical.
http://docs.readthedocs.org/en/latest/canonical.html
-->
<link rel="canonical" href="http://eventflow.readthedocs.io/" />

<link rel="stylesheet" href="https://media.readthedocs.org/css/readthedocs-doc-embed.css" type="text/css" />

<script type="text/javascript" src="_static/readthedocs-data.js"></script>

<!-- Add page-specific data, which must exist in the page js, not global -->
<script type="text/javascript">
READTHEDOCS_DATA['page'] = 'index'
</script>

<script type="text/javascript" src="_static/readthedocs-dynamic-include.js"></script>

<!-- end RTD <extrahead> --></head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html#document-index" class="icon icon-home"> EventFlow
          

          
          </a>

          
            
            
            
              <div class="version">
                latest
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
            
              <!-- Local TOC -->
              <div class="local-toc"><ul>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-GettingStarted">Getting started</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#example-application">Example application</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#aggregate-identity">Aggregate identity</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#aggregate">Aggregate</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#event">Event</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#command">Command</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#command-handler">Command handler</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#read-model">Read model</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#next-steps">Next steps</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Basics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-Identity">Identity</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-Aggregates">Aggregates</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#events">Events</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#emitting-events">Emitting events</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#applying-events">Applying events</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-Commands">Commands</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#ensure-idempotency">Ensure idempotency</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-Subscribers">Subscribers</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#synchronous-subscribers">Synchronous subscribers</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#asynchronous-subscribers">Asynchronous subscribers</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#subscribe-to-every-event">Subscribe to every event</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-Metadata">Metadata</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#custom-metadata-provider">Custom metadata provider</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#additional-built-in-providers">Additional built-in providers</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-Queries">Queries</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#queries-shipped-with-eventflow">Queries shipped with EventFlow</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-Sagas">Sagas</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#alternative-saga-store">Alternative saga store</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-Jobs">Jobs</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#be-careful-when-using-jobs">Be careful when using jobs</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#create-your-own-jobs">Create your own jobs</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#hangfire">Hangfire</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-EventUpgrade">Event upgrade</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#example-removing-a-damaged-event">Example - removing a damaged event</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#example-replace-event">Example - replace event</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Stores</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-EventStore">Event stores</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#in-memory">In-memory</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#mssql-event-store">MSSQL event store</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#files">Files</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-ReadStores">Read model stores</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#creating-read-models">Creating read models</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#read-model-locators">Read model locators</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#read-store-implementations">Read store implementations</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Integration</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-MSSQL">Microsoft SQL Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-RabbitMQ">RabbitMQ</a></li>
</ul>
<p class="caption"><span class="caption-text">Additional reading</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-Configuration">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-IoC">IoC container</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#autofac">Autofac</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-Log">Log</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-Snapshots">Snapshots</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#snapshot-strategy">Snapshot strategy</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#upgrading-snapshots">Upgrading snapshots</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#snapshot-store-implementations">Snapshot store implementations</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-Customize">Customize</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#decorating-implementations">Decorating implementations</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#registering-new-implementations">Registering new implementations</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-ValueObjects">Event serialization and value objects</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#making-pretty-and-clean-json">Making pretty and clean JSON</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-DosAndDonts">Do&#8217;s and don&#8217;ts</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#business-rules">Business rules</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#events">Events</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-Specifications">Specifications</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-FAQ">FAQ - frequently asked questions</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#how-can-i-ensure-that-only-specific-users-can-execute-commands">How can I ensure that only specific users can execute commands?</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#why-isn-t-there-a-global-sequence-number-on-domain-events">Why isn&#8217;t there a &#8220;global sequence number&#8221; on domain events?</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#why-doesn-t-eventflow-have-a-unit-of-work-concept">Why doesn&#8217;t EventFlow have a unit of work concept?</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#why-are-subscribers-are-receiving-events-out-of-order">Why are subscribers are receiving events out of order?</a></li>
</ul>
</li>
</ul>
</div>
            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html#document-index">EventFlow</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html#document-index">Docs</a> &raquo;</li>
        
      <li>EventFlow 0.1 documentation</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            
              <a href="https://github.com/eventflow/EventFlow/blob/develop/Documentation/index.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="welcome-to-eventflow-s-documentation">
<h1>Welcome to EventFlow&#8217;s documentation!<a class="headerlink" href="#welcome-to-eventflow-s-documentation" title="Permalink to this headline">¶</a></h1>
<a class="reference internal image-reference" href="_images/icon-128.png"><img alt="EventFlow logo" class="align-right" src="_images/icon-128.png" style="width: 128px; height: 128px;" /></a>
<p>EventFlow is a basic CQRS+ES framework designed to be easy to use.</p>
<p>Have a look at our <a class="reference internal" href="index.html#getting-started"><span class="std std-ref">getting started guide</span></a>, the
<a class="reference internal" href="index.html#dos-and-donts"><span class="std std-ref">do’s and don’ts</span></a>  and the <a class="reference internal" href="index.html#faq"><span class="std std-ref">FAQ</span></a>.</p>
<p>Contents:</p>
<div class="toctree-wrapper compound">
<span id="document-GettingStarted"></span><div class="section" id="getting-started">
<span id="id1"></span><h2>Getting started<a class="headerlink" href="#getting-started" title="Permalink to this headline">¶</a></h2>
<p>Initializing EventFlow always start with an <code class="docutils literal"><span class="pre">EventFlowOptions.New</span></code> as this
performs the initial bootstrap and starts the fluent configuration API. The
very minimum initialization of EventFlow can be done in a single line, but
wouldn&#8217;t serve any purpose as no domain has been configured.</p>
<div class="highlight-c#"><div class="highlight"><pre><span></span><span class="kt">var</span> <span class="n">resolver</span> <span class="p">=</span> <span class="n">EventFlowOptions</span><span class="p">.</span><span class="n">New</span><span class="p">.</span><span class="n">CreateResolver</span><span class="p">();</span>
</pre></div>
</div>
<p>The above line does configures several important defaults</p>
<ul class="simple">
<li>Custom internal IoC container</li>
<li>In-memory <a class="reference internal" href="index.html#eventstores"><span class="std std-ref">event store</span></a></li>
<li>Console logger</li>
<li>A &#8220;null&#8221; snapshot store, that merely writes a warning if used (no need to
do anything before going to production if you aren&#8217;t planning to use
snapshots)</li>
<li>And lastly, default implementations of all the internal parts of EventFlow</li>
</ul>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p>Before using EventFlow in a production environment, you should configure an
alternative <strong>event store</strong>, an alternative <strong>IoC container</strong> and another
<strong>logger</strong> that sends log messages to your production log store.</p>
<ul class="last simple">
<li><a class="reference internal" href="index.html#ioc-container"><span class="std std-ref">IoC container</span></a></li>
<li><a class="reference internal" href="index.html#log"><span class="std std-ref">Log</span></a></li>
<li><a class="reference internal" href="index.html#eventstores"><span class="std std-ref">Event store</span></a></li>
<li><a class="reference internal" href="index.html#snapshots"><span class="std std-ref">Snapshots</span></a></li>
</ul>
</div>
<p>To start using EventFlow, a domain must be configure which consists of the
following parts</p>
<ul class="simple">
<li><a class="reference internal" href="index.html#aggregates"><span class="std std-ref">Aggregate</span></a></li>
<li><a class="reference internal" href="index.html#identity"><span class="std std-ref">Aggregate identity</span></a></li>
<li><a class="reference internal" href="index.html#events"><span class="std std-ref">Aggregate events</span></a></li>
<li><a class="reference internal" href="index.html#commands"><span class="std std-ref">Commands and command handlers</span></a> (optional, but highly recommended)</li>
</ul>
<p>In addition to the above, EventFlow provides several optional features. Whether
or not these features are utilized, depends on the application in which
EventFlow is used.</p>
<ul class="simple">
<li><a class="reference internal" href="index.html#read-stores"><span class="std std-ref">Read models</span></a></li>
<li><a class="reference internal" href="index.html#subscribers"><span class="std std-ref">Subscribers</span></a></li>
<li><a class="reference internal" href="index.html#event-upgrade"><span class="std std-ref">Event upgraders</span></a></li>
<li><a class="reference internal" href="index.html#queries"><span class="std std-ref">Queries</span></a></li>
<li><a class="reference internal" href="index.html#jobs"><span class="std std-ref">Jobs</span></a></li>
<li><a class="reference internal" href="index.html#snapshots"><span class="std std-ref">Snapshots</span></a></li>
<li><a class="reference internal" href="index.html#sagas"><span class="std std-ref">Sagas</span></a></li>
<li><a class="reference internal" href="index.html#metadata-providers"><span class="std std-ref">Metadata providers</span></a></li>
</ul>
<div class="section" id="example-application">
<h3>Example application<a class="headerlink" href="#example-application" title="Permalink to this headline">¶</a></h3>
<p>To get started, we start with our entire example application which consists of
one of each of the required parts: aggregate, event, aggregate identity, command
and a command handler. After we will go through the individual parts created.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The example code provided here is located within the EventFlow code base
exactly as shown, so if you would like to debug and step through the
entire flow, checkout the code and execute the <code class="docutils literal"><span class="pre">GettingStartedExample</span></code>
test.</p>
</div>
<p>All classes create for the example application are prefixed with <code class="docutils literal"><span class="pre">Example</span></code>.</p>
<div class="highlight-c#"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// We wire up EventFlow with all of our classes. Instead of adding events,</span>
<span class="c1">// commands, etc. explicitly, we could have used the the simpler</span>
<span class="c1">// AddDefaults(Assembly) instead.</span>
<span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">resolver</span> <span class="p">=</span> <span class="n">EventFlowOptions</span><span class="p">.</span><span class="n">New</span>
    <span class="p">.</span><span class="n">AddEvents</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">ExampleEvent</span><span class="p">))</span>
    <span class="p">.</span><span class="n">AddCommands</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">ExampleCommand</span><span class="p">))</span>
    <span class="p">.</span><span class="n">AddCommandHandlers</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">ExampleCommandHandler</span><span class="p">))</span>
    <span class="p">.</span><span class="n">UseInMemoryReadStoreFor</span><span class="p">&lt;</span><span class="n">ExampleReadModel</span><span class="p">&gt;()</span>
    <span class="p">.</span><span class="n">CreateResolver</span><span class="p">())</span>
<span class="p">{</span>
    <span class="c1">// Create a new identity for our aggregate root</span>
    <span class="kt">var</span> <span class="n">exampleId</span> <span class="p">=</span> <span class="n">ExampleId</span><span class="p">.</span><span class="n">New</span><span class="p">;</span>

    <span class="c1">// Define some important value</span>
    <span class="k">const</span> <span class="kt">int</span> <span class="n">magicNumber</span> <span class="p">=</span> <span class="m">42</span><span class="p">;</span>

    <span class="c1">// Resolve the command bus and use it to publish a command</span>
    <span class="kt">var</span> <span class="n">commandBus</span> <span class="p">=</span> <span class="n">resolver</span><span class="p">.</span><span class="n">Resolve</span><span class="p">&lt;</span><span class="n">ICommandBus</span><span class="p">&gt;();</span>
    <span class="k">await</span> <span class="n">commandBus</span><span class="p">.</span><span class="n">PublishAsync</span><span class="p">(</span>
        <span class="k">new</span> <span class="nf">ExampleCommand</span><span class="p">(</span><span class="n">exampleId</span><span class="p">,</span> <span class="n">magicNumber</span><span class="p">),</span>
        <span class="n">CancellationToken</span><span class="p">.</span><span class="n">None</span><span class="p">)</span>
        <span class="p">.</span><span class="n">ConfigureAwait</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>

    <span class="c1">// Resolve the query handler and use the built-in query for fetching</span>
    <span class="c1">// read models by identity to get our read model representing the</span>
    <span class="c1">// state of our aggregate root</span>
    <span class="kt">var</span> <span class="n">queryProcessor</span> <span class="p">=</span> <span class="n">resolver</span><span class="p">.</span><span class="n">Resolve</span><span class="p">&lt;</span><span class="n">IQueryProcessor</span><span class="p">&gt;();</span>
    <span class="kt">var</span> <span class="n">exampleReadModel</span> <span class="p">=</span> <span class="k">await</span> <span class="n">queryProcessor</span><span class="p">.</span><span class="n">ProcessAsync</span><span class="p">(</span>
        <span class="k">new</span> <span class="n">ReadModelByIdQuery</span><span class="p">&lt;</span><span class="n">ExampleReadModel</span><span class="p">&gt;(</span><span class="n">exampleId</span><span class="p">),</span>
        <span class="n">CancellationToken</span><span class="p">.</span><span class="n">None</span><span class="p">)</span>
        <span class="p">.</span><span class="n">ConfigureAwait</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>

    <span class="c1">// Verify that the read model has the expected magic number</span>
    <span class="n">exampleReadModel</span><span class="p">.</span><span class="n">MagicNumber</span><span class="p">.</span><span class="n">Should</span><span class="p">().</span><span class="n">Be</span><span class="p">(</span><span class="m">42</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>The above example publishes the <code class="docutils literal"><span class="pre">ExampleCommand</span></code> to the aggregate with the
<code class="docutils literal"><span class="pre">exampleId</span></code> identity with the magical value of <code class="docutils literal"><span class="pre">42</span></code>. After the command has
been published, the accompanying read model <code class="docutils literal"><span class="pre">ExampleReadModel</span></code> is fetched
and we verify that the magical number has reached it.</p>
<p>During the execution of the example application, a single event is emitted and
stored in the in-memory event store. The JSON for the event is shown here.</p>
<div class="highlight-json"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;MagicNumber&quot;</span><span class="p">:</span> <span class="mi">42</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The event data itself is straightforward as it is merely the JSON serialization of
an instance of the type <code class="docutils literal"><span class="pre">ExampleEvent</span></code> with the value we defined. A bit more
interesting is the metadata that EventFlow stores along the event, which is
used by the EventFlow event store.</p>
<div class="highlight-json"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;timestamp&quot;</span><span class="p">:</span> <span class="s2">&quot;2016-11-09T20:56:28.5019198+01:00&quot;</span><span class="p">,</span>
  <span class="nt">&quot;aggregate_sequence_number&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
  <span class="nt">&quot;aggregate_name&quot;</span><span class="p">:</span> <span class="s2">&quot;ExampleAggrenate&quot;</span><span class="p">,</span>
  <span class="nt">&quot;aggregate_id&quot;</span><span class="p">:</span> <span class="s2">&quot;example-c1d4a2b1-c75b-4c53-ae44-e67ee1ddfd79&quot;</span><span class="p">,</span>
  <span class="nt">&quot;event_id&quot;</span><span class="p">:</span> <span class="s2">&quot;event-d5622eaa-d1d3-5f57-8023-4b97fabace90&quot;</span><span class="p">,</span>
  <span class="nt">&quot;timestamp_epoch&quot;</span><span class="p">:</span> <span class="s2">&quot;1478721389&quot;</span><span class="p">,</span>
  <span class="nt">&quot;batch_id&quot;</span><span class="p">:</span> <span class="s2">&quot;52e9d7e9-3a98-44c5-926a-fc416e20556c&quot;</span><span class="p">,</span>
  <span class="nt">&quot;source_id&quot;</span><span class="p">:</span> <span class="s2">&quot;command-69176516-07b7-4142-beaf-dba82586152c&quot;</span><span class="p">,</span>
  <span class="nt">&quot;event_name&quot;</span><span class="p">:</span> <span class="s2">&quot;example&quot;</span><span class="p">,</span>
  <span class="nt">&quot;event_version&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>All the built-in meta data is available on each instance of <code class="docutils literal"><span class="pre">IDomainEvent&lt;,,&gt;</span></code>,
which is accessible from event handlers for e.g. read models or subscribers. It
also possible create your own <a class="reference internal" href="index.html#metadata-providers-custom"><span class="std std-ref">meta data providers</span></a>
or add additional EventFlow built-in providers as needed.</p>
</div>
<div class="section" id="aggregate-identity">
<h3>Aggregate identity<a class="headerlink" href="#aggregate-identity" title="Permalink to this headline">¶</a></h3>
<p>The aggregate ID is in EventFlow represented as a value objected that inherits
from the <code class="docutils literal"><span class="pre">IIdentity</span></code> interface. You can provide your own implementation, but
EventFlow provides a convenient implementation that will suit most needs.  Be
sure to read the read the section about the <a class="reference internal" href="index.html#identity"><span class="std std-ref">Identity&lt;&gt;</span></a> class
to get details on how to use it.</p>
<p>For our example application we use the built-in class making the implementation
very simple.</p>
<div class="highlight-c#"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">/// Represents the aggregate identity (ID)</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">ExampleId</span> <span class="p">:</span>
    <span class="n">Identity</span><span class="p">&lt;</span><span class="n">ExampleId</span><span class="p">&gt;</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nf">ExampleId</span><span class="p">(</span><span class="kt">string</span> <span class="k">value</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="k">value</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="aggregate">
<h3>Aggregate<a class="headerlink" href="#aggregate" title="Permalink to this headline">¶</a></h3>
<p>Now we&#8217;ll take a look at the <code class="docutils literal"><span class="pre">ExampleAggregate</span></code>. Its rather simple as the
only thing it can, is apply the magic number once.</p>
<div class="highlight-c#"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">/// The aggregate root</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">ExampleAggregate</span> <span class="p">:</span>
    <span class="n">AggregateRoot</span><span class="p">&lt;</span><span class="n">ExampleAggregate</span><span class="p">,</span> <span class="n">ExampleId</span><span class="p">&gt;,</span>
    <span class="n">IEmit</span><span class="p">&lt;</span><span class="n">ExampleEvent</span><span class="p">&gt;</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="kt">int?</span> <span class="n">_magicNumber</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">ExampleAggregate</span><span class="p">(</span><span class="n">ExampleId</span> <span class="n">id</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>

    <span class="c1">// Method invoked by our command</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">SetMagicNumer</span><span class="p">(</span><span class="kt">int</span> <span class="n">magicNumber</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">_magicNumber</span><span class="p">.</span><span class="n">HasValue</span><span class="p">)</span>
            <span class="k">throw</span> <span class="n">DomainError</span><span class="p">.</span><span class="n">With</span><span class="p">(</span><span class="s">&quot;Magic number already set&quot;</span><span class="p">);</span>

        <span class="n">Emit</span><span class="p">(</span><span class="k">new</span> <span class="n">ExampleEvent</span><span class="p">(</span><span class="n">magicNumber</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="c1">// We apply the event as part of the event sourcing system. EventFlow</span>
    <span class="c1">// provides several different methods for doing this, e.g. state objects,</span>
    <span class="c1">// the Apply method is merely the simplest</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">Apply</span><span class="p">(</span><span class="n">ExampleEvent</span> <span class="n">aggregateEvent</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_magicNumber</span> <span class="p">=</span> <span class="n">aggregateEvent</span><span class="p">.</span><span class="n">MagicNumber</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>Be sure to read the section on <a class="reference internal" href="index.html#aggregates"><span class="std std-ref">aggregates</span></a> to get all the
details right, but for now the most important thing to note, is that the state
of the aggregate (updating the <code class="docutils literal"><span class="pre">_magicNumber</span></code> variable) happens in the
<code class="docutils literal"><span class="pre">Apply(ExampleEvent)</span></code> method. This is the event sourcing part of EventFlow in
effect. As state changes are only saved as events, mutating the aggregate state
must happen in such a way that the state changes are replayed the next the
aggregate is loaded. EventFlow has a <a class="reference internal" href="index.html#aggregates-applying-events"><span class="std std-ref">set of different approaches</span></a>
that you can select from, but in this example we use the <cite>Apply</cite> methods as
they are the simplest.</p>
<p>The <code class="docutils literal"><span class="pre">ExampleAggregate</span></code> exposes the <code class="docutils literal"><span class="pre">SetMagicNumer(int)</span></code> method, which
is used to expose the business rules for changing the magic number. If the
magic number hasn&#8217;t been set before, the event <code class="docutils literal"><span class="pre">ExampleEvent</span></code> is emitted
and the aggregate state is mutated.</p>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p class="last">The <code class="docutils literal"><span class="pre">Apply(ExampleEvent)</span></code> is invoked by the <code class="docutils literal"><span class="pre">Emit(...)</span></code> method, so
after the event has been emitted, the aggregate state has changed.</p>
</div>
</div>
<div class="section" id="event">
<h3>Event<a class="headerlink" href="#event" title="Permalink to this headline">¶</a></h3>
<p>Next up is the event which represents some that <strong>has</strong> happend in our domain.
In this example, its merely that some magic number has been set. Normally
these events should have a really, really good name and represent something in the
ubiquitous language for the domain.</p>
<div class="highlight-c#"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">/// A basic event containing some information</span>
<span class="na">[EventVersion(&quot;example&quot;, 1)]</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">ExampleEvent</span> <span class="p">:</span>
    <span class="n">AggregateEvent</span><span class="p">&lt;</span><span class="n">ExampleAggregate</span><span class="p">,</span> <span class="n">ExampleId</span><span class="p">&gt;</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nf">ExampleEvent</span><span class="p">(</span><span class="kt">int</span> <span class="n">magicNumber</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">MagicNumber</span> <span class="p">=</span> <span class="n">magicNumber</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="kt">int</span> <span class="n">MagicNumber</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>We have applied the <code class="docutils literal"><span class="pre">[EventVersion(&quot;example&quot;,</span> <span class="pre">1)]</span></code> to our event, marking it
as the <code class="docutils literal"><span class="pre">example</span></code> event version <code class="docutils literal"><span class="pre">1</span></code>, which directly corresponds to the
<code class="docutils literal"><span class="pre">event_name</span></code> and <code class="docutils literal"><span class="pre">event_version</span></code> from the meta data store along side the
event mentioned. The information is used by EventFlow to tie name and version to
a specific .NET type.</p>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p class="last">Even though the using the <code class="docutils literal"><span class="pre">EventVersion</span></code> attribute is optional, its
<strong>highly recommended</strong>. EventFlow will infer the information if it isn&#8217;t
provided and thus making it vulnerable to e.g. type renames.</p>
</div>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p class="last">Once have aggregates in your production environment that have emitted
an event, you should never change the .NET implementation. You can deprecate
it, but you should never change the type or the data stored in the event
store.</p>
</div>
</div>
<div class="section" id="command">
<h3>Command<a class="headerlink" href="#command" title="Permalink to this headline">¶</a></h3>
<p>Commands are the entry point to the domain and if you remember from the example
application, they are published using the <code class="docutils literal"><span class="pre">ICommandBus</span></code> as shown here.</p>
<div class="highlight-c#"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// Resolve the command bus and use it to publish a command</span>
<span class="kt">var</span> <span class="n">commandBus</span> <span class="p">=</span> <span class="n">resolver</span><span class="p">.</span><span class="n">Resolve</span><span class="p">&lt;</span><span class="n">ICommandBus</span><span class="p">&gt;();</span>
<span class="k">await</span> <span class="n">commandBus</span><span class="p">.</span><span class="n">PublishAsync</span><span class="p">(</span>
    <span class="k">new</span> <span class="nf">ExampleCommand</span><span class="p">(</span><span class="n">exampleId</span><span class="p">,</span> <span class="n">magicNumber</span><span class="p">),</span>
    <span class="n">CancellationToken</span><span class="p">.</span><span class="n">None</span><span class="p">)</span>
    <span class="p">.</span><span class="n">ConfigureAwait</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
<p>In EventFlow commands are simple value objects that merely how the arguments for
the command execution. All commands implement the <code class="docutils literal"><span class="pre">ICommand&lt;,&gt;</span></code> interface, but
EventFlow provides an easy-to-use base class that you can use.</p>
<div class="highlight-c#"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">/// Command for update magic number</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">ExampleCommand</span> <span class="p">:</span>
    <span class="n">Command</span><span class="p">&lt;</span><span class="n">ExampleAggregate</span><span class="p">,</span> <span class="n">ExampleId</span><span class="p">&gt;</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nf">ExampleCommand</span><span class="p">(</span>
        <span class="n">ExampleId</span> <span class="n">aggregateId</span><span class="p">,</span>
        <span class="kt">int</span> <span class="n">magicNumber</span><span class="p">)</span>
        <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">aggregateId</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">MagicNumber</span> <span class="p">=</span> <span class="n">magicNumber</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="kt">int</span> <span class="n">MagicNumber</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>A command doesn&#8217;t do anything without a command handler. In fact, EventFlow
will throw an exception if a command doesn&#8217;t have exactly <strong>one</strong> command
handler registered.</p>
</div>
<div class="section" id="command-handler">
<h3>Command handler<a class="headerlink" href="#command-handler" title="Permalink to this headline">¶</a></h3>
<p>The command handler provides the glue between the command, the aggregate and
the IoC container as it defines how a command is executed. Typically they are
rather simple, but they could contain more complex logic. How much is up to you.</p>
<div class="highlight-c#"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">/// Command handler for our command</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">ExampleCommandHandler</span> <span class="p">:</span>
    <span class="n">CommandHandler</span><span class="p">&lt;</span><span class="n">ExampleAggregate</span><span class="p">,</span> <span class="n">ExampleId</span><span class="p">,</span> <span class="n">ExampleCommand</span><span class="p">&gt;</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">override</span> <span class="n">Task</span> <span class="nf">ExecuteAsync</span><span class="p">(</span>
        <span class="n">ExampleAggregate</span> <span class="n">aggregate</span><span class="p">,</span>
        <span class="n">ExampleCommand</span> <span class="n">command</span><span class="p">,</span>
        <span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">aggregate</span><span class="p">.</span><span class="n">SetMagicNumer</span><span class="p">(</span><span class="n">command</span><span class="p">.</span><span class="n">MagicNumber</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">Task</span><span class="p">.</span><span class="n">FromResult</span><span class="p">(</span><span class="m">0</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>The <code class="docutils literal"><span class="pre">ExampleCommandHandler</span></code> in our case here merely invokes the
<code class="docutils literal"><span class="pre">SetMagicNumer</span></code> on the aggregate.</p>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p class="last">Everything inside the <code class="docutils literal"><span class="pre">ExecuteAsync(...)</span></code> method of a command handler
<strong>may</strong> be executed more than once if there&#8217;s an optimistic concurrency
exception, i.e., something else has happened to the aggregate since it
as loaded from the event store and its therefor automatically reloaded by
EventFlow. It is therefor essential that the command handler doesn&#8217;t mutate
anything other than the aggregate.</p>
</div>
</div>
<div class="section" id="read-model">
<h3>Read model<a class="headerlink" href="#read-model" title="Permalink to this headline">¶</a></h3>
<p>If you ever need to access the data in your aggregates efficiently, its important
that <a class="reference internal" href="index.html#read-stores"><span class="std std-ref">read models</span></a> are used. Loading aggregates from the
event store takes time and its impossible to query for e.g. aggregates that have
a specific value in its state.</p>
<p>In our example we merely use the built-in in-memory read model store. Its useful
in many cases, e.g. executing automated domain tests in an CI build.</p>
<div class="highlight-c#"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">/// Read model for our aggregate</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">ExampleReadModel</span> <span class="p">:</span>
    <span class="n">IReadModel</span><span class="p">,</span>
    <span class="n">IAmReadModelFor</span><span class="p">&lt;</span><span class="n">ExampleAggregate</span><span class="p">,</span> <span class="n">ExampleId</span><span class="p">,</span> <span class="n">ExampleEvent</span><span class="p">&gt;</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">MagicNumber</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">Apply</span><span class="p">(</span>
        <span class="n">IReadModelContext</span> <span class="n">context</span><span class="p">,</span>
        <span class="n">IDomainEvent</span><span class="p">&lt;</span><span class="n">ExampleAggregate</span><span class="p">,</span> <span class="n">ExampleId</span><span class="p">,</span> <span class="n">ExampleEvent</span><span class="p">&gt;</span> <span class="n">domainEvent</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">MagicNumber</span> <span class="p">=</span> <span class="n">domainEvent</span><span class="p">.</span><span class="n">AggregateEvent</span><span class="p">.</span><span class="n">MagicNumber</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>Notice the <code class="docutils literal"><span class="pre">IDomainEvent&lt;ExampleAggrenate,</span> <span class="pre">ExampleId,</span> <span class="pre">ExampleEvent&gt;</span> <span class="pre">domainEvent</span></code>
argument, its merely a wrapper around the specific event we implemented
earlier. The <code class="docutils literal"><span class="pre">IDomainEvent&lt;,,&gt;</span></code> provides additional information, e.g. any
meta data store along side the event.</p>
<p>The main difference between the event instance emitted in the aggregate and the
instance wrapped here, is that the event has been committed to the event store.</p>
</div>
<div class="section" id="next-steps">
<h3>Next steps<a class="headerlink" href="#next-steps" title="Permalink to this headline">¶</a></h3>
<p>Although the implementation in this guide enables you to create a complete
application, there are several topics that are recommended as next steps.</p>
<ul class="simple">
<li>Read the <a class="reference internal" href="index.html#dos-and-donts"><span class="std std-ref">dos and donts</span></a> section</li>
<li>Use <a class="reference internal" href="index.html#value-objects"><span class="std std-ref">value objects</span></a> to produce cleaner JSON</li>
<li>If your application need to act on an emitted event, create a
<a class="reference internal" href="index.html#subscribers"><span class="std std-ref">subscriber</span></a></li>
<li>Check the <a class="reference internal" href="index.html#configuration"><span class="std std-ref">configuration</span></a> to make sure everything
is as you would like it</li>
<li>Setup a persistent event store using e.g.
<a class="reference internal" href="index.html#eventstore-mssql"><span class="std std-ref">Microsoft SQL Server</span></a></li>
<li>Create <a class="reference internal" href="index.html#read-stores"><span class="std std-ref">read models</span></a> for efficient querying</li>
<li>Consider the use of <a class="reference internal" href="index.html#specifications"><span class="std std-ref">specifications</span></a> to ease
creation of business rules</li>
</ul>
</div>
</div>
</div>
<div class="toctree-wrapper compound">
<span id="document-Identity"></span><div class="section" id="identity">
<span id="id1"></span><h2>Identity<a class="headerlink" href="#identity" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal"><span class="pre">Identity&lt;&gt;</span></code> value object provides generic functionality to create
and validate the IDs of e.g. aggregate roots. Its basically a wrapper
around a <code class="docutils literal"><span class="pre">Guid</span></code>.</p>
<p>Lets say we want to create a new identity named <code class="docutils literal"><span class="pre">TestId</span></code> we could do
it like this.</p>
<div class="highlight-c#"><div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">class</span> <span class="nc">TestId</span> <span class="p">:</span> <span class="n">Identity</span><span class="p">&lt;</span><span class="n">TestId</span><span class="p">&gt;</span>
<span class="p">{</span>
  <span class="k">public</span> <span class="nf">TestId</span><span class="p">(</span><span class="kt">string</span> <span class="k">value</span><span class="p">)</span>
   <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="k">value</span><span class="p">)</span>
  <span class="p">{</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li>The identity follow the form <code class="docutils literal"><span class="pre">{class</span> <span class="pre">without</span> <span class="pre">&quot;Id&quot;}-{guid}</span></code> e.g.
<code class="docutils literal"><span class="pre">test-c93fdb8c-5c9a-4134-bbcd-87c0644ca34f</span></code> for the above
<code class="docutils literal"><span class="pre">TestId</span></code> example</li>
<li>The internal <code class="docutils literal"><span class="pre">Guid</span></code> can be generated using one of the following
methods/properties. Note that you can access the <code class="docutils literal"><span class="pre">Guid</span></code> factories
directly by accessing the static methods on the <code class="docutils literal"><span class="pre">GuidFactories</span></code>
class</li>
<li><code class="docutils literal"><span class="pre">New</span></code>: Uses the standard <code class="docutils literal"><span class="pre">Guid.NewGuid()</span></code></li>
<li><code class="docutils literal"><span class="pre">NewDeterministic(...)</span></code>: Creates a name-based <code class="docutils literal"><span class="pre">Guid</span></code> using the
algorithm from <a class="reference external" href="https://www.ietf.org/rfc/rfc4122.txt">RFC 4122</a>
§4.3, which allows identities to be generated based on known data,
e.g. an user e-mail, i.e., it always returns the same identity for
the same arguments</li>
<li><code class="docutils literal"><span class="pre">NewComb()</span></code>: Creates a sequential <code class="docutils literal"><span class="pre">Guid</span></code> that can be used to e.g.
avoid database fragmentation</li>
<li>A <code class="docutils literal"><span class="pre">string</span></code> can be tested to see if its a valid identity using the
static <code class="docutils literal"><span class="pre">bool</span> <span class="pre">IsValid(string)</span></code> method</li>
<li>Any validation errors can be gathered using the static
<code class="docutils literal"><span class="pre">IEnumerable&lt;string&gt;</span> <span class="pre">Validate(string)</span></code> method</li>
</ul>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p class="last">Its very important to name the constructor argument <code class="docutils literal"><span class="pre">value</span></code>
as it is significant when the identity type is deserialized.</p>
</div>
<p>Here&#8217;s some examples on we can use our newly created <code class="docutils literal"><span class="pre">TestId</span></code></p>
<div class="highlight-c#"><div class="highlight"><pre><span></span><span class="c1">// Uses the default Guid.NewGuid()</span>
<span class="kt">var</span> <span class="n">testId</span> <span class="p">=</span> <span class="n">TestId</span><span class="p">.</span><span class="n">New</span>
</pre></div>
</div>
<div class="highlight-c#"><div class="highlight"><pre><span></span><span class="c1">// Create a namespace, put this in a constant somewhere</span>
<span class="kt">var</span> <span class="n">emailNamespace</span> <span class="p">=</span> <span class="n">Guid</span><span class="p">.</span><span class="n">Parse</span><span class="p">(</span><span class="s">&quot;769077C6-F84D-46E3-AD2E-828A576AAAF3&quot;</span><span class="p">);</span>

<span class="c1">// Creates an identity with the value &quot;test-9181a444-af25-567e-a866-c263b6f6119a&quot;</span>
<span class="kt">var</span> <span class="n">testId</span> <span class="p">=</span> <span class="n">TestId</span><span class="p">.</span><span class="n">NewDeterministic</span><span class="p">(</span><span class="n">emailNamespace</span><span class="p">,</span> <span class="s">&quot;test@example.com&quot;</span><span class="p">);</span>
</pre></div>
</div>
<div class="highlight-c#"><div class="highlight"><pre><span></span><span class="c1">// Creates a new identity every time, but an identity when used in e.g.</span>
<span class="c1">// database indexes, minimizes fragmentation</span>
<span class="kt">var</span> <span class="n">testId</span> <span class="p">=</span> <span class="n">TestId</span><span class="p">.</span><span class="n">NewComb</span><span class="p">()</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Be sure to read the section about
<a class="reference internal" href="index.html#value-objects"><span class="std std-ref">value objects</span></a> as the <code class="docutils literal"><span class="pre">Identity&lt;&gt;</span></code> is basically a
value object.</p>
</div>
</div>
<span id="document-Aggregates"></span><div class="section" id="aggregates">
<span id="id1"></span><h2>Aggregates<a class="headerlink" href="#aggregates" title="Permalink to this headline">¶</a></h2>
<p>Initially before you can create a aggregate, you need to create its
identity. You can create your own implementation by implementing the
<code class="docutils literal"><span class="pre">IIdentity</span></code> interface or you can use a base class <code class="docutils literal"><span class="pre">Identity&lt;&gt;</span></code> that
EventFlow provides, like this.</p>
<div class="highlight-c#"><div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">class</span> <span class="nc">TestId</span> <span class="p">:</span> <span class="n">Identity</span><span class="p">&lt;</span><span class="n">TestId</span><span class="p">&gt;</span>
<span class="p">{</span>
  <span class="k">public</span> <span class="nf">TestId</span><span class="p">(</span><span class="kt">string</span> <span class="k">value</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="k">value</span><span class="p">)</span>
  <span class="p">{</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <a class="reference internal" href="index.html#identity"><span class="std std-ref">Identity&lt;&gt;</span></a> value object
provides generic functionality to create and validate aggregate root
IDs. Please read the documentation regarding the bundled <code class="docutils literal"><span class="pre">Identity&lt;&gt;</span></code>
type as it provides several useful features, e.g. several different
schemes for ID generation, one that minimizes MSSQL database
fragmentation.</p>
<p>Next, to create a new aggregate, simply inherit from
<code class="docutils literal"><span class="pre">AggregateRoot&lt;,&gt;</span></code> like this, making sure to pass test aggregate own
type as the first generic argument and the identity as the second.</p>
<div class="highlight-c#"><div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">class</span> <span class="nc">TestAggregate</span> <span class="p">:</span> <span class="n">AggregateRoot</span><span class="p">&lt;</span><span class="n">TestAggregate</span><span class="p">,</span> <span class="n">TestId</span><span class="p">&gt;</span>
<span class="p">{</span>
  <span class="k">public</span> <span class="nf">TestAggregate</span><span class="p">(</span><span class="n">TestId</span> <span class="n">id</span><span class="p">)</span>
    <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
  <span class="p">{</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="section" id="events">
<span id="id2"></span><h3>Events<a class="headerlink" href="#events" title="Permalink to this headline">¶</a></h3>
<p>In an event source system like EventFlow, aggregate root data are stored
on events.</p>
<div class="highlight-c#"><div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">class</span> <span class="nc">PingEvent</span> <span class="p">:</span> <span class="n">AggregateEvent</span><span class="p">&lt;</span><span class="n">TestAggregate</span><span class="p">,</span> <span class="n">TestId</span><span class="p">&gt;</span>
<span class="p">{</span>
  <span class="k">public</span> <span class="kt">string</span> <span class="n">Data</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>

  <span class="k">public</span> <span class="nf">PingEvent</span><span class="p">(</span><span class="kt">string</span> <span class="n">data</span><span class="p">)</span>
  <span class="p">{</span>
      <span class="n">Data</span> <span class="p">=</span> <span class="n">data</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Please make sure to read the section on <a class="reference internal" href="index.html#value-objects"><span class="std std-ref">value objects and
events</span></a> for some important notes on creating
events.</p>
</div>
<div class="section" id="emitting-events">
<h3>Emitting events<a class="headerlink" href="#emitting-events" title="Permalink to this headline">¶</a></h3>
<p>In order to emit an event from an aggregate, call the <code class="docutils literal"><span class="pre">protected</span></code>
<code class="docutils literal"><span class="pre">Emit(...)</span></code> method which applies the event and adds it to the list of
uncommitted events.</p>
<div class="highlight-c#"><div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">void</span> <span class="nf">Ping</span><span class="p">(</span><span class="kt">string</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
  <span class="c1">// Fancy domain logic here that validates aggregate state...</span>

  <span class="k">if</span> <span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="n">IsNullOrEmpty</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
  <span class="p">{</span>
    <span class="k">throw</span> <span class="n">DomainError</span><span class="p">.</span><span class="n">With</span><span class="p">(</span><span class="s">&quot;Ping data empty&quot;</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="n">Emit</span><span class="p">(</span><span class="k">new</span> <span class="n">PingEvent</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Remember not to do any changes to the aggregate with the these methods,
as the state is only stored through events.</p>
</div>
<div class="section" id="applying-events">
<span id="aggregates-applying-events"></span><h3>Applying events<a class="headerlink" href="#applying-events" title="Permalink to this headline">¶</a></h3>
<p>Currently EventFlow has three methods of applying events to the
aggregate when emitted or loaded from the event store. Which you choose
is up to you, implementing <code class="docutils literal"><span class="pre">IEmit&lt;SomeEvent&gt;</span></code> is the most convenient,
but will expose public <code class="docutils literal"><span class="pre">Apply</span></code> methods.</p>
<ul class="simple">
<li>Create a method called <code class="docutils literal"><span class="pre">Apply</span></code> that takes the event as argument. To
get the method signature right, implement the <code class="docutils literal"><span class="pre">IEmit&lt;SomeEvent&gt;</span></code> on
your aggregate. This is the default fallback and you will get an
exception if no other strategies are configured. Although you <em>can</em>
implement <code class="docutils literal"><span class="pre">IEmit&lt;SomeEvent&gt;</span></code>, its optional, the <code class="docutils literal"><span class="pre">Apply</span></code> methods
can be <code class="docutils literal"><span class="pre">protected</span></code> or <code class="docutils literal"><span class="pre">private</span></code></li>
<li>Create a state object by inheriting from <code class="docutils literal"><span class="pre">AggregateState&lt;,,&gt;</span></code> and
registering using the protected <code class="docutils literal"><span class="pre">Register(...)</span></code> in the aggregate
root constructor</li>
<li>Register a specific handler for a event using the protected
<code class="docutils literal"><span class="pre">Register&lt;SomeEvent&gt;(e</span> <span class="pre">=&gt;</span> <span class="pre">Handler(e))</span></code> from within the constructor</li>
<li>Register an event applier using
<code class="docutils literal"><span class="pre">Register(IEventApplier</span> <span class="pre">eventApplier)</span></code>, which could be a e.g. state
object</li>
</ul>
</div>
</div>
<span id="document-Commands"></span><div class="section" id="commands">
<span id="id1"></span><h2>Commands<a class="headerlink" href="#commands" title="Permalink to this headline">¶</a></h2>
<p>Commands are the basic value objects, or models, that represent write
operations that you can perform in your domain.</p>
<p>As an example, one might implement create this command for updating user
passwords.</p>
<div class="highlight-c#"><div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">class</span> <span class="nc">UserUpdatePasswordCommand</span> <span class="p">:</span> <span class="n">Command</span><span class="p">&lt;</span><span class="n">UserAggregate</span><span class="p">,</span> <span class="n">UserId</span><span class="p">&gt;</span>
<span class="p">{</span>
  <span class="k">public</span> <span class="n">Password</span> <span class="n">NewPassword</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
  <span class="k">public</span> <span class="n">Password</span> <span class="n">OldPassword</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>

  <span class="k">public</span> <span class="nf">UserUpdatePasswordCommand</span><span class="p">(</span>
    <span class="n">UserId</span> <span class="n">id</span><span class="p">,</span>
    <span class="n">Password</span> <span class="n">newPassword</span><span class="p">,</span>
    <span class="n">Password</span> <span class="n">oldPassword</span><span class="p">)</span>
    <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">Username</span> <span class="p">=</span> <span class="n">username</span><span class="p">;</span>
    <span class="n">Password</span> <span class="p">=</span> <span class="n">password</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Note that the <code class="docutils literal"><span class="pre">Password</span></code> class is merely a value object created to
hold the password and do basic validation. Read the article regarding
<a class="reference internal" href="index.html#value-objects"><span class="std std-ref">value objects</span></a> for more information. Also, you
don&#8217;t have to use the default EventFlow <code class="docutils literal"><span class="pre">Command&lt;,&gt;</span></code> implementation,
you can create your own, it merely have to implement the <code class="docutils literal"><span class="pre">ICommand&lt;,&gt;</span></code>
interface.</p>
<p>A command by itself doesn&#8217;t do anything and will throw an exception if
published. To make a command work, you need to implement one (and only
one) command handler which is responsible for invoking the aggregate.</p>
<div class="highlight-c#"><div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">class</span> <span class="nc">UserUpdatePasswordCommandHandler</span> <span class="p">:</span>
  <span class="n">CommandHandler</span><span class="p">&lt;</span><span class="n">UserAggregate</span><span class="p">,</span> <span class="n">UserId</span><span class="p">,</span> <span class="n">UserUpdatePasswordCommand</span><span class="p">&gt;</span>
<span class="p">{</span>
  <span class="k">public</span> <span class="k">override</span> <span class="n">Task</span> <span class="nf">ExecuteAsync</span><span class="p">(</span>
    <span class="n">UserAggregate</span> <span class="n">aggregate</span><span class="p">,</span>
    <span class="n">UserUpdatePasswordCommand</span> <span class="n">command</span><span class="p">,</span>
    <span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">aggregate</span><span class="p">.</span><span class="n">UpdatePassword</span><span class="p">(</span>
      <span class="n">command</span><span class="p">.</span><span class="n">OldPassword</span><span class="p">,</span>
      <span class="n">command</span><span class="p">.</span><span class="n">NewPassword</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">Task</span><span class="p">.</span><span class="n">FromResult</span><span class="p">(</span><span class="m">0</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="section" id="ensure-idempotency">
<h3>Ensure idempotency<a class="headerlink" href="#ensure-idempotency" title="Permalink to this headline">¶</a></h3>
<p>Detecting duplicate operations can be hard, especially if you have a
distributed application, or simply a web application. Consider the
following simplified scenario.</p>
<ol class="arabic simple">
<li>The user wants to change his password</li>
<li>The user fills in the &#8220;change password form&#8221;</li>
<li>As user is impatient, or by accident, the user submits the for twice</li>
<li>The first web request completes and the password is changed. However,
as the browser is waiting on the first web request, this result is
ignored</li>
<li>The second web request throws a domain error as the &#8220;old password&#8221;
doesn&#8217;t match as the current password has already been changed</li>
<li>The user is presented with a error on the web page</li>
</ol>
<p>Handling this is simple, merely ensure that the aggregate is idempotent
is regards to password changes. But instead of implementing this
yourself, EventFlow has support for it and its simple to utilize and is
done per command.</p>
<p>To use the functionality, merely ensure that commands that represent the
same operation has the same <code class="docutils literal"><span class="pre">ISourceId</span></code> which implements <code class="docutils literal"><span class="pre">IIdentity</span></code>
like the example blow.</p>
<div class="highlight-c#"><div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">class</span> <span class="nc">UserUpdatePasswordCommand</span> <span class="p">:</span> <span class="n">Command</span><span class="p">&lt;</span><span class="n">UserAggregate</span><span class="p">,</span> <span class="n">UserId</span><span class="p">&gt;</span>
<span class="p">{</span>
  <span class="k">public</span> <span class="n">Password</span> <span class="n">NewPassword</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
  <span class="k">public</span> <span class="n">Password</span> <span class="n">OldPassword</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>

  <span class="k">public</span> <span class="nf">UserCreateCommand</span><span class="p">(</span>
    <span class="n">UserId</span> <span class="n">id</span><span class="p">,</span>
    <span class="n">ISourceId</span> <span class="n">sourceId</span><span class="p">,</span>
    <span class="n">Password</span> <span class="n">newPassword</span><span class="p">,</span>
    <span class="n">Password</span> <span class="n">oldPassword</span><span class="p">)</span>
    <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">sourceId</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">Username</span> <span class="p">=</span> <span class="n">username</span><span class="p">;</span>
    <span class="n">Password</span> <span class="p">=</span> <span class="n">password</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Note the use of the other <code class="docutils literal"><span class="pre">protected</span></code> constructor of <code class="docutils literal"><span class="pre">Command&lt;,&gt;</span></code>
that takes a <code class="docutils literal"><span class="pre">ISourceId</span></code> in addition to the aggregate root identity.</p>
<p>If a duplicate command is detected, a <code class="docutils literal"><span class="pre">DuplicateOperationException</span></code> is
thrown. The application could then ignore the exception or report the
problem to the end user.</p>
<p>The default <code class="docutils literal"><span class="pre">ISourceId</span></code> history size of the aggregate root, is ten.
But it can be configured using the <code class="docutils literal"><span class="pre">SetSourceIdHistory(...)</span></code> that must
be called from within the aggregate root constructor.</p>
<div class="section" id="easier-isourceid-calculation">
<h4>Easier ISourceId calculation<a class="headerlink" href="#easier-isourceid-calculation" title="Permalink to this headline">¶</a></h4>
<p>Ensuring the correct calculation of the command <code class="docutils literal"><span class="pre">ISourceId</span></code> can be
somewhat cumbersome, which is why EventFlow provides another base
command you can use, the <code class="docutils literal"><span class="pre">DistinctCommand&lt;,&gt;</span></code>. By using the
<code class="docutils literal"><span class="pre">DistinctCommand&lt;,&gt;</span></code> you merely have to implement the
<code class="docutils literal"><span class="pre">GetSourceIdComponents()</span></code> and providing the <code class="docutils literal"><span class="pre">IEnumerable&lt;byte[]&gt;</span></code>
that makes the command unique. The bytes is used to create a
deterministic GUID to be used as an <code class="docutils literal"><span class="pre">ISourceId</span></code>.</p>
<div class="highlight-c#"><div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">class</span> <span class="nc">UserUpdatePasswordCommand</span> <span class="p">:</span>
  <span class="n">DistinctCommand</span><span class="p">&lt;</span><span class="n">UserAggregate</span><span class="p">,</span> <span class="n">UserId</span><span class="p">&gt;</span>
<span class="p">{</span>
  <span class="k">public</span> <span class="n">Password</span> <span class="n">NewPassword</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
  <span class="k">public</span> <span class="n">Password</span> <span class="n">OldPassword</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>

  <span class="k">public</span> <span class="nf">UserUpdatePasswordCommand</span><span class="p">(</span>
    <span class="n">UserId</span> <span class="n">id</span><span class="p">,</span>
    <span class="n">Password</span> <span class="n">newPassword</span><span class="p">,</span>
    <span class="n">Password</span> <span class="n">oldPassword</span><span class="p">)</span>
    <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">Username</span> <span class="p">=</span> <span class="n">username</span><span class="p">;</span>
    <span class="n">Password</span> <span class="p">=</span> <span class="n">password</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">protected</span> <span class="k">override</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="kt">byte</span><span class="p">[]&gt;</span> <span class="n">GetSourceIdComponents</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="k">yield</span> <span class="k">return</span> <span class="n">NewPassword</span><span class="p">.</span><span class="n">GetBytes</span><span class="p">();</span>
    <span class="k">yield</span> <span class="k">return</span> <span class="n">OldPassword</span><span class="p">.</span><span class="n">GetBytes</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">GetBytes()</span></code> merely returns the <code class="docutils literal"><span class="pre">Encoding.UTF8.GetBytes(...)</span></code> of
the password.</p>
<div class="admonition caution">
<p class="first admonition-title">Caution</p>
<p class="last">Don&#8217;t use the <code class="docutils literal"><span class="pre">GetHashCode()</span></code>, as the implementation
is different for e.g. <code class="docutils literal"><span class="pre">string</span></code> on 32 bit and 64 bit .NET.</p>
</div>
</div>
</div>
</div>
<span id="document-Subscribers"></span><div class="section" id="subscribers">
<span id="id1"></span><h2>Subscribers<a class="headerlink" href="#subscribers" title="Permalink to this headline">¶</a></h2>
<p>Whenever your application needs to act when a specific event is emitted
from your domain you create a class that implement one of the following
two interfaces which is.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">ISubscribeSynchronousTo&lt;TAggregate,TIdentity,TEvent&gt;</span></code>: Executed
synchronous</li>
<li><code class="docutils literal"><span class="pre">ISubscribeAsynchronousTo&lt;TAggregate,TIdentity,TEvent&gt;</span></code>: Executed
asynchronous</li>
</ul>
<p>Any implemented subscribers needs to be registered to this interface,
either using <code class="docutils literal"><span class="pre">AddSubscriber(...)</span></code>, <code class="docutils literal"><span class="pre">AddSubscribers(...)</span></code> or
<code class="docutils literal"><span class="pre">AddDefaults(...)</span></code> during initialization. If you have configured a
custom IoC container, you can register the implementations using it
instead.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The <em>synchronous</em> and <em>asynchronous</em> here has nothing to do
with the .NET framework keywords <code class="docutils literal"><span class="pre">async</span></code>, <code class="docutils literal"><span class="pre">await</span></code> or the Task
Parallel Library. It refers to how the subscribers are executed. Read
below for details.</p>
</div>
<div class="section" id="synchronous-subscribers">
<span id="subscribers-sync"></span><h3>Synchronous subscribers<a class="headerlink" href="#synchronous-subscribers" title="Permalink to this headline">¶</a></h3>
<p>Synchronous subscribers in EventFlow are executed one at a time for each
emitted domain event in order. This e.g. guarantees that all subscribers
have been executed when the <code class="docutils literal"><span class="pre">ICommandBus.PublishAsync(...)</span></code> returns.</p>
<p>The <code class="docutils literal"><span class="pre">ISubscribeSynchronousTo&lt;,,&gt;</span></code> is shown here.</p>
<div class="highlight-c#"><div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">interface</span> <span class="n">ISubscribeSynchronousTo</span><span class="p">&lt;</span><span class="n">TAggregate</span><span class="p">,</span> <span class="k">in</span> <span class="n">TIdentity</span><span class="p">,</span> <span class="k">in</span> <span class="n">TEvent</span><span class="p">&gt;</span>
    <span class="k">where</span> <span class="n">TAggregate</span> <span class="p">:</span> <span class="n">IAggregateRoot</span><span class="p">&lt;</span><span class="n">TIdentity</span><span class="p">&gt;</span>
    <span class="k">where</span> <span class="n">TIdentity</span> <span class="p">:</span> <span class="n">IIdentity</span>
    <span class="k">where</span> <span class="n">TEvent</span> <span class="p">:</span> <span class="n">IAggregateEvent</span><span class="p">&lt;</span><span class="n">TAggregate</span><span class="p">,</span> <span class="n">TIdentity</span><span class="p">&gt;</span>
<span class="p">{</span>
  <span class="n">Task</span> <span class="nf">HandleAsync</span><span class="p">(</span>
    <span class="n">IDomainEvent</span><span class="p">&lt;</span><span class="n">TAggregate</span><span class="p">,</span> <span class="n">TIdentity</span><span class="p">,</span> <span class="n">TEvent</span><span class="p">&gt;</span> <span class="n">domainEvent</span><span class="p">,</span>
    <span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="section" id="out-of-order-events">
<span id="out-of-order-event-subscribers"></span><h4>Out of order events<a class="headerlink" href="#out-of-order-events" title="Permalink to this headline">¶</a></h4>
<p>As synchronous subscribers are by their very nature executed
synchronously, emitting multiple events from an aggregate and letting
subscribers publish new commands based on this can however lead to some
unexpected behavior as &#8220;innermost&#8221; subscribers will be executed before
first.</p>
<ol class="arabic simple">
<li>Aggregate emits events <code class="docutils literal"><span class="pre">Event</span> <span class="pre">1</span></code> and <code class="docutils literal"><span class="pre">Event</span> <span class="pre">2</span></code></li>
<li>Subscriber handles <code class="docutils literal"><span class="pre">Event</span> <span class="pre">1</span></code> and publishes a command that results
in <code class="docutils literal"><span class="pre">Event</span> <span class="pre">3</span></code> being emitted</li>
<li>Subscriber handles <code class="docutils literal"><span class="pre">Event</span> <span class="pre">3</span></code> (doesn&#8217;t affect the domain)</li>
<li>Subscriber handles <code class="docutils literal"><span class="pre">Event</span> <span class="pre">2</span></code></li>
</ol>
<p>In the above example the subscriber will handle the events in the
following order <code class="docutils literal"><span class="pre">Event</span> <span class="pre">1</span></code>, <code class="docutils literal"><span class="pre">Event</span> <span class="pre">3</span></code> and then <code class="docutils literal"><span class="pre">Event</span> <span class="pre">2</span></code>. While
this <em>could</em> occur in a distributed system or executing subscribers on
different threads, its a certainty when using synchronous subscribers.</p>
</div>
<div class="section" id="exceptions-swallowed-by-default">
<h4>Exceptions swallowed by default<a class="headerlink" href="#exceptions-swallowed-by-default" title="Permalink to this headline">¶</a></h4>
<p>By default any exceptions thrown by a subscriber are <strong>swallowed</strong>
by EventFlow after it has been logged as an error. Depending on the
application this might be the preferred behavior, but in some cases
it isn&#8217;t. If subscriber exception should be thrown, and thus allowing
them to be caught in e.g. command handlers, the behaivor can be disabled
by setting the <code class="docutils literal"><span class="pre">ThrowSubscriberExceptions</span></code> to <code class="docutils literal"><span class="pre">true</span></code> like illustrated
here.</p>
<div class="highlight-c#"><div class="highlight"><pre><span></span><span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">resolver</span> <span class="p">=</span> <span class="n">EventFlowOptions</span><span class="p">.</span><span class="n">New</span>
  <span class="p">.</span><span class="n">Configure</span><span class="p">(</span><span class="n">c</span> <span class="p">=&gt;</span> <span class="n">c</span><span class="p">.</span><span class="n">ThrowSubscriberExceptions</span> <span class="p">=</span> <span class="k">true</span><span class="p">)</span>
  <span class="p">.</span><span class="n">CreateResolver</span><span class="p">())</span>
<span class="p">{</span>
  <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="asynchronous-subscribers">
<span id="subscribers-async"></span><h3>Asynchronous subscribers<a class="headerlink" href="#asynchronous-subscribers" title="Permalink to this headline">¶</a></h3>
<p>Asynchronous subscribers in EventFlow are executed using a scheduled job.</p>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p class="last">Asynchronous subscribers are <strong>disabled by default</strong> and must be
enabled using the following configuration.</p>
</div>
<div class="highlight-c#"><div class="highlight"><pre><span></span><span class="n">eventFlowOptions</span><span class="p">.</span><span class="n">Configure</span><span class="p">(</span><span class="n">c</span> <span class="p">=&gt;</span> <span class="n">IsAsynchronousSubscribersEnabled</span> <span class="p">=</span> <span class="k">true</span><span class="p">);</span>
</pre></div>
</div>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p class="last">As asynchronous subscribers are executed using a job, its important
to configure proper job scheduling by e.g. using the
<code class="docutils literal"><span class="pre">EventFlow.Hangfire</span></code> NuGet package.</p>
</div>
<p>The <code class="docutils literal"><span class="pre">ISubscribeAsynchronousTo&lt;,,&gt;</span></code> is shown here and is, besides its
name, identical to its synchronous counterpart.</p>
<div class="highlight-c#"><div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">interface</span> <span class="n">ISubscribeAsynchronousTo</span><span class="p">&lt;</span><span class="n">TAggregate</span><span class="p">,</span> <span class="k">in</span> <span class="n">TIdentity</span><span class="p">,</span> <span class="k">in</span> <span class="n">TEvent</span><span class="p">&gt;</span>
    <span class="k">where</span> <span class="n">TAggregate</span> <span class="p">:</span> <span class="n">IAggregateRoot</span><span class="p">&lt;</span><span class="n">TIdentity</span><span class="p">&gt;</span>
    <span class="k">where</span> <span class="n">TIdentity</span> <span class="p">:</span> <span class="n">IIdentity</span>
    <span class="k">where</span> <span class="n">TEvent</span> <span class="p">:</span> <span class="n">IAggregateEvent</span><span class="p">&lt;</span><span class="n">TAggregate</span><span class="p">,</span> <span class="n">TIdentity</span><span class="p">&gt;</span>
<span class="p">{</span>
  <span class="n">Task</span> <span class="nf">HandleAsync</span><span class="p">(</span>
    <span class="n">IDomainEvent</span><span class="p">&lt;</span><span class="n">TAggregate</span><span class="p">,</span> <span class="n">TIdentity</span><span class="p">,</span> <span class="n">TEvent</span><span class="p">&gt;</span> <span class="n">domainEvent</span><span class="p">,</span>
    <span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Setting <code class="docutils literal"><span class="pre">ThrowSubscriberExceptions</span> <span class="pre">=</span> <span class="pre">true</span></code> has <strong>no effect</strong>
on asynchronous subscribers.</p>
</div>
</div>
<div class="section" id="subscribe-to-every-event">
<h3>Subscribe to every event<a class="headerlink" href="#subscribe-to-every-event" title="Permalink to this headline">¶</a></h3>
<p>Instead of subscribing to every single domain, you can register an
implementation of <code class="docutils literal"><span class="pre">ISubscribeSynchronousToAll</span></code> which is defined as
shown here.</p>
<div class="highlight-c#"><div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">interface</span> <span class="n">ISubscribeSynchronousToAll</span>
<span class="p">{</span>
    <span class="n">Task</span> <span class="nf">HandleAsync</span><span class="p">(</span>
        <span class="n">IReadOnlyCollection</span><span class="p">&lt;</span><span class="n">IDomainEvent</span><span class="p">&gt;</span> <span class="n">domainEvents</span><span class="p">,</span>
        <span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Any registered implementations will be notified for every domain event
emitted.</p>
<div class="section" id="rabbitmq">
<span id="subscribers-rabbitmq"></span><h4>RabbitMQ<a class="headerlink" href="#rabbitmq" title="Permalink to this headline">¶</a></h4>
<p>See <a class="reference internal" href="index.html#setup-rabbitmq"><span class="std std-ref">RabbitMQ setup</span></a> for details on how to get
started using <a class="reference external" href="https://www.rabbitmq.com/">RabbitMQ</a>.</p>
<p>After RabbitMQ has been configured, all domain events are published
to a exchange named <code class="docutils literal"><span class="pre">eventflow</span></code> with routing keys in the following
format.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">eventflow</span><span class="o">.</span><span class="n">domainevent</span><span class="o">.</span><span class="p">[</span><span class="n">Aggregate</span> <span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="p">[</span><span class="n">Event</span> <span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="p">[</span><span class="n">Event</span> <span class="n">version</span><span class="p">]</span>
</pre></div>
</div>
<p>Which will be the following for an event named <code class="docutils literal"><span class="pre">CreateUser</span></code> version
<code class="docutils literal"><span class="pre">1</span></code> for the <code class="docutils literal"><span class="pre">MyUserAggregate</span></code>.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">eventflow</span><span class="o">.</span><span class="n">domainevent</span><span class="o">.</span><span class="n">my</span><span class="o">-</span><span class="n">user</span><span class="o">.</span><span class="n">create</span><span class="o">-</span><span class="n">user</span><span class="o">.</span><span class="mi">1</span>
</pre></div>
</div>
<p>Note the lowercasing and adding of <code class="docutils literal"><span class="pre">-</span></code> whenever there&#8217;s a capital
letter.</p>
<p>All the above is the default behavior, if you don&#8217;t like it replace e.g.
the service <code class="docutils literal"><span class="pre">IRabbitMqMessageFactory</span></code> to customize what routing key or
exchange to use. Have a look at how
<a class="reference external" href="https://github.com/rasmus/EventFlow">EventFlow</a> has done its
implementation to get started.</p>
</div>
</div>
</div>
<span id="document-Metadata"></span><div class="section" id="metadata">
<span id="metadata-providers"></span><h2>Metadata<a class="headerlink" href="#metadata" title="Permalink to this headline">¶</a></h2>
<p>Metadata is all the &#8220;additional&#8221; information that resides with a emitted
event, some of which is required information.</p>
<p>In EventFlow metadata is merely a <code class="docutils literal"><span class="pre">IEnumerable</span></code> of
<code class="docutils literal"><span class="pre">KeyValuePair&lt;string,string&gt;</span></code> for which each is a metadata entry.</p>
<p>Out of the box these metadata keys are added to each aggregate event.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">event_name</span></code> and <code class="docutils literal"><span class="pre">event_version</span></code> - A name and version for the
event which is used during event deserialization.</li>
<li><code class="docutils literal"><span class="pre">timestamp</span></code> - A <code class="docutils literal"><span class="pre">DateTimeOffset</span></code> for when the event was emitted
from the aggregate.</li>
<li><code class="docutils literal"><span class="pre">aggregate_sequence_number</span></code> - The version the aggregate was after
the event was emitted, e.g. <code class="docutils literal"><span class="pre">1</span></code> for the very first event emitted.</li>
</ul>
<div class="section" id="custom-metadata-provider">
<span id="metadata-providers-custom"></span><h3>Custom metadata provider<a class="headerlink" href="#custom-metadata-provider" title="Permalink to this headline">¶</a></h3>
<p>If you require additional information to be stored along with each
event, then you can implement the <code class="docutils literal"><span class="pre">IMetadataProvider</span></code> interface and
register the class using e.g. <code class="docutils literal"><span class="pre">.AddMetadataProvider(...)</span></code> on
<code class="docutils literal"><span class="pre">EventFlowOptions</span></code>.</p>
</div>
<div class="section" id="additional-built-in-providers">
<h3>Additional built-in providers<a class="headerlink" href="#additional-built-in-providers" title="Permalink to this headline">¶</a></h3>
<p>EventFlow ships with a collection of ready-to-use providers in some of
its NuGet packages.</p>
<div class="section" id="eventflow">
<h4>EventFlow<a class="headerlink" href="#eventflow" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><strong>AddEventTypeMetadataProvider</strong></li>
<li><code class="docutils literal"><span class="pre">event_type_assembly_name</span></code> - Assembly name of the assembly
containing the event</li>
<li><code class="docutils literal"><span class="pre">event_type_assembly_version</span></code> - Assembly version of the assembly
containing the event</li>
<li><code class="docutils literal"><span class="pre">event_type_fullname</span></code> - Full name of the event corresponding to
<code class="docutils literal"><span class="pre">Type.FullName</span></code> for the aggregate event type.</li>
<li><strong>AddGuidMetadataProvider</strong></li>
<li><code class="docutils literal"><span class="pre">guid</span></code> - A new <code class="docutils literal"><span class="pre">Guid</span></code> for each event.</li>
<li><strong>AddMachineNameMetadataProvider</strong></li>
<li><code class="docutils literal"><span class="pre">environment_machinename</span></code> - Adds the machine name handling the
event from <code class="docutils literal"><span class="pre">Environment.MachineName</span></code></li>
</ul>
</div>
<div class="section" id="eventflow-owin">
<h4>EventFlow.Owin<a class="headerlink" href="#eventflow-owin" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><strong>AddRequestHeadersMetadataProvider</strong></li>
<li><code class="docutils literal"><span class="pre">request_header[HEADER]</span></code> - Adds all headers from the OWIN request
as metadata, each as a separate entry for which <code class="docutils literal"><span class="pre">HEADER</span></code> in the is
replace with the name of the header. E.g. the
<code class="docutils literal"><span class="pre">request_header[Connection]</span></code> might contain the value
<code class="docutils literal"><span class="pre">Keep-Alive</span></code>.</li>
<li><strong>AddUriMetadataProvider</strong></li>
<li><code class="docutils literal"><span class="pre">request_uri</span></code> - OWIN request URI.</li>
<li><code class="docutils literal"><span class="pre">request_method</span></code> - OWIN request method.</li>
<li><strong>AddUserHostAddressMetadataProvider</strong></li>
<li><code class="docutils literal"><span class="pre">user_host_address</span></code> - The provider tries to find the correct user
host address by inspecting request headers, i.e., if you have a load
balancer in front of your application, then the request IP is not the
real user address, but the load balancer should send the user IP as a
header.</li>
<li><code class="docutils literal"><span class="pre">user_host_address_source_header</span></code> - The header for of which the
user host address was taken.</li>
<li><code class="docutils literal"><span class="pre">remote_ip_address</span></code> - The remote IP address. Note that this might
be the IP address of your load balancer.</li>
</ul>
</div>
</div>
</div>
<span id="document-Queries"></span><div class="section" id="queries">
<span id="id1"></span><h2>Queries<a class="headerlink" href="#queries" title="Permalink to this headline">¶</a></h2>
<p>Creating queries in EventFlow is simple.</p>
<p>First create a value object that contains the data required for the
query. In this example we want to search for users based on their
username.</p>
<div class="highlight-c#"><div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">class</span> <span class="nc">GetUserByUsernameQuery</span> <span class="p">:</span> <span class="n">IQuery</span><span class="p">&lt;</span><span class="n">User</span><span class="p">&gt;</span>
<span class="p">{</span>
  <span class="k">public</span> <span class="kt">string</span> <span class="n">Username</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>

  <span class="k">public</span> <span class="nf">GetUserByUsernameQuery</span><span class="p">(</span><span class="kt">string</span> <span class="n">username</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">Username</span> <span class="p">=</span> <span class="n">username</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Next create a query handler that implements how the query is processed.</p>
<div class="highlight-c#"><div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">class</span> <span class="nc">GetUserByUsernameQueryHandler</span> <span class="p">:</span>
  <span class="n">IQueryHandler</span><span class="p">&lt;</span><span class="n">GetUserByUsernameQuery</span><span class="p">,</span> <span class="n">User</span><span class="p">&gt;</span>
<span class="p">{</span>
  <span class="k">private</span> <span class="n">IUserReadModelRepository</span> <span class="n">_userReadModelRepository</span><span class="p">;</span>

  <span class="k">public</span> <span class="nf">GetUserByUsernameQueryHandler</span><span class="p">(</span>
    <span class="n">IUserReadModelRepository</span> <span class="n">userReadModelRepository</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">_userReadModelRepository</span> <span class="p">=</span> <span class="n">userReadModelRepository</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">Task</span><span class="p">&lt;</span><span class="n">User</span><span class="p">&gt;</span> <span class="n">ExecuteQueryAsync</span><span class="p">(</span>
    <span class="n">GetUserByUsernameQuery</span> <span class="n">query</span><span class="p">,</span>
    <span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">return</span> <span class="n">_userReadModelRepository</span><span class="p">.</span><span class="n">GetByUsernameAsync</span><span class="p">(</span>
      <span class="n">query</span><span class="p">.</span><span class="n">Username</span><span class="p">,</span>
      <span class="n">cancellationToken</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Last step is to register the query handler in EventFlow. Here we show
the simple, but cumbersome version, you should use one of the overloads
that scans an entire assembly.</p>
<div class="highlight-c#"><div class="highlight"><pre><span></span><span class="p">...</span>
<span class="n">EventFlowOptions</span><span class="p">.</span><span class="n">New</span>
  <span class="p">.</span><span class="n">AddQueryHandler</span><span class="p">&lt;</span><span class="n">GetUserByUsernameQueryHandler</span><span class="p">,</span> <span class="n">GetUserByUsernameQuery</span><span class="p">,</span> <span class="n">User</span><span class="p">&gt;()</span>
<span class="p">...</span>
</pre></div>
</div>
<p>Then in order to use the query in your application, you need a reference
to the <code class="docutils literal"><span class="pre">IQueryProcessor</span></code>, which in our case is stored in the
<code class="docutils literal"><span class="pre">_queryProcessor</span></code> field.</p>
<div class="highlight-c#"><div class="highlight"><pre><span></span><span class="p">...</span>
<span class="kt">var</span> <span class="n">user</span> <span class="p">=</span> <span class="k">await</span> <span class="n">_queryProcessor</span><span class="p">.</span><span class="n">ProcessAsync</span><span class="p">(</span>
  <span class="k">new</span> <span class="nf">GetUserByUsernameQuery</span><span class="p">(</span><span class="s">&quot;root&quot;</span><span class="p">)</span>
  <span class="n">cancellationToken</span><span class="p">)</span>
  <span class="p">.</span><span class="n">ConfigureAwait</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>
<span class="p">...</span>
</pre></div>
</div>
<div class="section" id="queries-shipped-with-eventflow">
<h3>Queries shipped with EventFlow<a class="headerlink" href="#queries-shipped-with-eventflow" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">ReadModelByIdQuery&lt;TReadModel&gt;</span></code>: Supported by both the in-memory
and MSSQL read model stores automatically as soon as you define the
read model use using the EventFlow options for that store</li>
<li><code class="docutils literal"><span class="pre">InMemoryQuery&lt;TReadModel&gt;</span></code>: Takes a <code class="docutils literal"><span class="pre">Predicate&lt;TReadModel&gt;</span></code> and
returns <code class="docutils literal"><span class="pre">IEnumerable&lt;TReadModel&gt;</span></code>, making it possible to search all
your in-memory read models based on any predicate</li>
</ul>
</div>
</div>
<span id="document-Sagas"></span><div class="section" id="sagas">
<span id="id1"></span><h2>Sagas<a class="headerlink" href="#sagas" title="Permalink to this headline">¶</a></h2>
<p>To coordinates messages between bounded contexts and aggregates
EventFlow provides a simple saga system.</p>
<ul class="simple">
<li><strong>Saga identity</strong></li>
<li><strong>Saga</strong></li>
<li><strong>Saga locator</strong></li>
<li><strong>Zero or more aggregates</strong></li>
</ul>
<p>This example is based on the chapter &#8220;A Saga on Sagas&#8221; from the <a class="reference external" href="https://msdn.microsoft.com/en-us/library/jj591569.aspx">CQRS
Journey</a> by
Microsoft, in which we want to model the process of placing an order.</p>
<ol class="arabic simple">
<li>User sends command <code class="docutils literal"><span class="pre">PlaceOrder</span></code> to the <code class="docutils literal"><span class="pre">OrderAggregate</span></code></li>
<li><code class="docutils literal"><span class="pre">OrderAggregate</span></code> emits an <code class="docutils literal"><span class="pre">OrderCreated</span></code> event</li>
<li><code class="docutils literal"><span class="pre">OrderSaga</span></code> handles <code class="docutils literal"><span class="pre">OrderCreated</span></code> by sending a
<code class="docutils literal"><span class="pre">MakeReservation</span></code> command to the <code class="docutils literal"><span class="pre">ReservationAggregate</span></code></li>
<li><code class="docutils literal"><span class="pre">ReservationAggregate</span></code> emits a <code class="docutils literal"><span class="pre">SeatsReserved</span></code> event</li>
<li><code class="docutils literal"><span class="pre">OrderSaga</span></code> handles <code class="docutils literal"><span class="pre">SeatsReserved</span></code> by sending a <code class="docutils literal"><span class="pre">MakePayment</span></code>
command to the <code class="docutils literal"><span class="pre">PaymentAggregate</span></code></li>
<li><code class="docutils literal"><span class="pre">PaymentAggregate</span></code> emits a <code class="docutils literal"><span class="pre">PaymentAccepted</span></code> event</li>
<li><code class="docutils literal"><span class="pre">OrderSaga</span></code> handles <code class="docutils literal"><span class="pre">PaymentAccepted</span></code> by emitting a
<code class="docutils literal"><span class="pre">OrderConfirmed</span></code> event with all the details, which via subscribers
updates the user, the <code class="docutils literal"><span class="pre">OrderAggregate</span></code> and the
<code class="docutils literal"><span class="pre">ReservationAggregate</span></code></li>
</ol>
<p>Next we need an <code class="docutils literal"><span class="pre">ISagaLocator</span></code> which basically maps domain events to a
saga identity allowing EventFlow to find it in its store.</p>
<p>In our case we will add the order ID to event metadata of all events
related to a specific order.</p>
<div class="highlight-c#"><div class="highlight"><pre><span></span>public class OrderSagaLocator : ISagaLocator
{
  public Task&lt;ISagaId&gt; LocateSagaAsync(
    IDomainEvent domainEvent,
    CancellationToken cancellationToken)
  {
    var orderId = domainEvent.Metadata[&quot;order-id&quot;];
    var orderSagaId = new OrderSagaId($&quot;ordersaga-{orderId}&quot;);

    return Task.FromResult&lt;ISagaId&gt;(orderSagaId);
  }
}
</pre></div>
</div>
<p>Alternatively the order identity could be added to every domain event
emitted from the <code class="docutils literal"><span class="pre">OrderAggregate</span></code>, <code class="docutils literal"><span class="pre">ReservationAggregate</span></code> and
<code class="docutils literal"><span class="pre">PaymentAggregate</span></code> aggregates that the <code class="docutils literal"><span class="pre">OrderSaga</span></code> subscribes to,
but this would depend on whether or not the order identity is part of
the ubiquitous language for your domain.</p>
<div class="highlight-c#"><div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">class</span> <span class="nc">OrderSaga</span>
  <span class="p">:</span> <span class="n">AggregateSaga</span><span class="p">&lt;</span><span class="n">OrderSaga</span><span class="p">,</span> <span class="n">OrderSagaId</span><span class="p">,</span> <span class="n">OrderSagaLocator</span><span class="p">&gt;,</span>
    <span class="n">ISagaIsStartedBy</span><span class="p">&lt;</span><span class="n">OrderAggregate</span><span class="p">,</span> <span class="n">OrderId</span><span class="p">,</span> <span class="n">OrderCreated</span><span class="p">&gt;</span>
<span class="p">{</span>
  <span class="k">public</span> <span class="n">Task</span> <span class="nf">HandleAsync</span><span class="p">(</span>
      <span class="n">IDomainEvent</span><span class="p">&lt;</span><span class="n">OrderAggregate</span><span class="p">,</span> <span class="n">OrderId</span><span class="p">,</span> <span class="n">OrderCreated</span><span class="p">&gt;</span> <span class="n">domainEvent</span><span class="p">,</span>
      <span class="n">ISagaContext</span> <span class="n">sagaContext</span><span class="p">,</span>
      <span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">// Update saga state with useful details.</span>
    <span class="n">Emit</span><span class="p">(</span><span class="k">new</span> <span class="n">OrderStarted</span><span class="p">(</span><span class="cm">/*...*/</span><span class="p">));</span>

    <span class="c1">// Make the reservation</span>
    <span class="n">Publish</span><span class="p">(</span><span class="k">new</span> <span class="n">MakeReservation</span><span class="p">(</span><span class="cm">/*...*/</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="k">public</span> <span class="k">void</span> <span class="nf">Apply</span><span class="p">(</span><span class="n">OrderStarted</span> <span class="n">e</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">// Update our aggregate state with relevant order details</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p class="last">Even though the method for publishing commands is named
<code class="docutils literal"><span class="pre">Publish</span></code>, the commands are only published to the command bus
<strong>after</strong> the aggregate has been successfully committed to the event
store (just like events). If an unexpected exception is throw by this
command publish, it should be handled by a custom implementation of
<code class="docutils literal"><span class="pre">ISagaErrorHandler</span></code>.</p>
</div>
<p>The next few events and commands are omitted, but at last the
<code class="docutils literal"><span class="pre">PaymentAggregate</span></code> emits its <code class="docutils literal"><span class="pre">PaymentAccepted</span></code> event and the saga
completes and emit the final <code class="docutils literal"><span class="pre">OrderConfirmed</span></code> event.</p>
<div class="highlight-c#"><div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">class</span> <span class="nc">OrderSaga</span>
  <span class="p">:</span> <span class="n">AggregateSaga</span><span class="p">&lt;</span><span class="n">OrderSaga</span><span class="p">,</span> <span class="n">OrderSagaId</span><span class="p">,</span> <span class="n">OrderSagaLocator</span><span class="p">&gt;,</span>
    <span class="p">...</span>
    <span class="n">ISagaHandles</span><span class="p">&lt;</span><span class="n">PaymentAggregate</span><span class="p">,</span> <span class="n">PaymentId</span><span class="p">,</span> <span class="n">PaymentAccepted</span><span class="p">&gt;</span>
<span class="p">{</span>

  <span class="p">...</span>

  <span class="k">public</span> <span class="n">Task</span> <span class="nf">HandleAsync</span><span class="p">(</span>
      <span class="n">IDomainEvent</span><span class="p">&lt;</span><span class="n">PaymentAggregate</span><span class="p">,</span> <span class="n">PaymentId</span><span class="p">,</span> <span class="n">PaymentAccepted</span><span class="p">&gt;</span> <span class="n">domainEvent</span><span class="p">,</span>
      <span class="n">ISagaContext</span> <span class="n">sagaContext</span><span class="p">,</span>
      <span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">Emit</span><span class="p">(</span><span class="k">new</span> <span class="n">OrderConfirmed</span><span class="p">(</span><span class="cm">/*...*/</span><span class="p">))</span>
  <span class="p">}</span>

  <span class="k">public</span> <span class="k">void</span> <span class="nf">Apply</span><span class="p">(</span><span class="n">OrderConfirmed</span> <span class="n">e</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">// As this is the last event, we complete the saga by calling Complete()</span>
    <span class="n">Complete</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">An <code class="docutils literal"><span class="pre">AggregateSaga&lt;,,&gt;</span></code> is only considered in its <code class="docutils literal"><span class="pre">running</span></code>
state if there has been an event and it hasn&#8217;t been marked as completed
(by invoking the <code class="docutils literal"><span class="pre">protected</span></code> <code class="docutils literal"><span class="pre">Complete()</span></code> method on the
<code class="docutils literal"><span class="pre">AggregateSaga&lt;,,&gt;</span></code>).</p>
</div>
<div class="section" id="alternative-saga-store">
<h3>Alternative saga store<a class="headerlink" href="#alternative-saga-store" title="Permalink to this headline">¶</a></h3>
<p>By default EventFlow is configured to use event sourcing and aggregate
roots for storage of sagas. However, you can implement your own storage
system by implementing <code class="docutils literal"><span class="pre">ISagaStore</span></code> and registering it.</p>
</div>
</div>
<span id="document-Jobs"></span><div class="section" id="jobs">
<span id="id1"></span><h2>Jobs<a class="headerlink" href="#jobs" title="Permalink to this headline">¶</a></h2>
<p>A job is basically a task that you either don&#8217;t want to execute in the
current context, on the current server or execute at a later time.
EventFlow provides basic functionality for jobs.</p>
<p>There are areas where you might find jobs very useful, here are some
examples</p>
<ul class="simple">
<li>Publish a command at a specific time in the future</li>
<li>Transient error handling</li>
</ul>
<div class="highlight-c#"><div class="highlight"><pre><span></span><span class="kt">var</span> <span class="n">jobScheduler</span> <span class="p">=</span> <span class="n">resolver</span><span class="p">.</span><span class="n">Resolve</span><span class="p">&lt;</span><span class="n">IJobScheduler</span><span class="p">&gt;();</span>
<span class="kt">var</span> <span class="n">job</span> <span class="p">=</span> <span class="n">PublishCommandJob</span><span class="p">.</span><span class="n">Create</span><span class="p">(</span><span class="k">new</span> <span class="n">SendEmailCommand</span><span class="p">(</span><span class="n">id</span><span class="p">),</span> <span class="n">resolver</span><span class="p">);</span>
<span class="k">await</span> <span class="n">jobScheduler</span><span class="p">.</span><span class="n">ScheduleAsync</span><span class="p">(</span>
  <span class="n">job</span><span class="p">,</span>
  <span class="n">TimeSpan</span><span class="p">.</span><span class="n">FromDays</span><span class="p">(</span><span class="m">7</span><span class="p">),</span>
  <span class="n">CancellationToken</span><span class="p">.</span><span class="n">None</span><span class="p">)</span>
  <span class="p">.</span><span class="n">ConfigureAwait</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>
</pre></div>
</div>
<p>In the above example the <code class="docutils literal"><span class="pre">SendEmailCommand</span></code> command will be published
in seven days.</p>
<div class="section" id="be-careful-when-using-jobs">
<h3>Be careful when using jobs<a class="headerlink" href="#be-careful-when-using-jobs" title="Permalink to this headline">¶</a></h3>
<p>When working with jobs, you should be aware of the following</p>
<ul class="simple">
<li>The default implementation does executes the job <em>now</em>, i.e., in the
current context. To get another behavior, install e.g.
<code class="docutils literal"><span class="pre">EventFlow.Hangfire</span></code> to get support for scheduled jobs. Read below
for details on how to configure Hangfire</li>
<li>Your jobs should serialize to JSON properly, see the section on
<a class="reference external" href="./ValueObjects.md">value objects</a> for more information</li>
<li>If you use the provided <code class="docutils literal"><span class="pre">PublishCommandJob</span></code>, make sure that your
commands serialize properly as well</li>
</ul>
</div>
<div class="section" id="create-your-own-jobs">
<h3>Create your own jobs<a class="headerlink" href="#create-your-own-jobs" title="Permalink to this headline">¶</a></h3>
<p>To create your own jobs, your job merely needs to implement the <code class="docutils literal"><span class="pre">IJob</span></code>
interface and be registered in EventFlow.</p>
<p>Here&#8217;s an example of a job implementing <code class="docutils literal"><span class="pre">IJob</span></code></p>
<div class="highlight-c#"><div class="highlight"><pre><span></span><span class="na">[JobVersion(&quot;LogMessage&quot;, 1)]</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">LogMessageJob</span> <span class="p">:</span> <span class="n">IJob</span>
<span class="p">{</span>
  <span class="k">public</span> <span class="nf">LogMessageJob</span><span class="p">(</span><span class="kt">string</span> <span class="n">message</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">Message</span> <span class="p">=</span> <span class="n">message</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">public</span> <span class="kt">string</span> <span class="n">Message</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>

  <span class="k">public</span> <span class="n">Task</span> <span class="nf">ExecuteAsync</span><span class="p">(</span>
    <span class="n">IResolver</span> <span class="n">resolver</span><span class="p">,</span>
    <span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="kt">var</span> <span class="n">log</span> <span class="p">=</span> <span class="n">resolver</span><span class="p">.</span><span class="n">Resolve</span><span class="p">&lt;</span><span class="n">ILog</span><span class="p">&gt;();</span>
    <span class="n">log</span><span class="p">.</span><span class="n">Debug</span><span class="p">(</span><span class="n">Message</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Note that the <code class="docutils literal"><span class="pre">JobVersion</span></code> attribute specifies the job name and
version to EventFlow and this is how EventFlow distinguishes between the
different job types. This makes it possible for you to reorder your
code, even rename the job type, as long as you keep the same attribute
values its considered the same job in EventFlow. If the attribute is
omitted, the name will be the type name and version will be <code class="docutils literal"><span class="pre">1</span></code>.</p>
<p>Here&#8217;s how the job is registered in EventFlow.</p>
<div class="highlight-c#"><div class="highlight"><pre><span></span><span class="kt">var</span> <span class="n">resolver</span> <span class="p">=</span> <span class="n">EventFlowOptions</span><span class="p">.</span><span class="k">new</span>
  <span class="p">.</span><span class="n">AddJobs</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">LogMessageJob</span><span class="p">))</span>
  <span class="p">...</span>
  <span class="p">.</span><span class="n">CreateResolver</span><span class="p">();</span>
</pre></div>
</div>
<p>Then to schedule the job</p>
<div class="highlight-c#"><div class="highlight"><pre><span></span><span class="kt">var</span> <span class="n">jobScheduler</span> <span class="p">=</span> <span class="n">resolver</span><span class="p">.</span><span class="n">Resolve</span><span class="p">&lt;</span><span class="n">IJobScheduler</span><span class="p">&gt;();</span>
<span class="kt">var</span> <span class="n">job</span> <span class="p">=</span> <span class="k">new</span> <span class="n">LogMessageJob</span><span class="p">(</span><span class="s">&quot;Great log message&quot;</span><span class="p">);</span>
<span class="k">await</span> <span class="n">jobScheduler</span><span class="p">.</span><span class="n">ScheduleAsync</span><span class="p">(</span>
  <span class="n">job</span><span class="p">,</span>
  <span class="n">TimeSpan</span><span class="p">.</span><span class="n">FromDays</span><span class="p">(</span><span class="m">7</span><span class="p">),</span>
  <span class="n">CancellationToken</span><span class="p">.</span><span class="n">None</span><span class="p">)</span>
  <span class="p">.</span><span class="n">ConfigureAwait</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="hangfire">
<h3>Hangfire<a class="headerlink" href="#hangfire" title="Permalink to this headline">¶</a></h3>
<p>To use <a class="reference external" href="http://hangfire.io/">Hangfire</a> as the job scheduler, install
the NuGet package <code class="docutils literal"><span class="pre">EventFlow.Hangfire</span></code> and configure EventFlow to use
the scheduler like this.</p>
<div class="highlight-c#"><div class="highlight"><pre><span></span><span class="kt">var</span> <span class="n">resolver</span> <span class="p">=</span> <span class="n">EventFlowOptions</span><span class="p">.</span><span class="k">new</span>
  <span class="p">.</span><span class="n">UseHangfireJobScheduler</span><span class="p">()</span> <span class="c1">// This line</span>
  <span class="p">...</span>
  <span class="p">.</span><span class="n">CreateResolver</span><span class="p">();</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The <code class="docutils literal"><span class="pre">UseHangfireJobScheduler()</span></code> doesn&#8217;t do any Hangfire
configuration, but merely registers the proper scheduler in EventFlow.</p>
</div>
</div>
</div>
<span id="document-EventUpgrade"></span><div class="section" id="event-upgrade">
<span id="id1"></span><h2>Event upgrade<a class="headerlink" href="#event-upgrade" title="Permalink to this headline">¶</a></h2>
<p>At some point you might find the need to replace a event with zero or
more events. Some use cases might be</p>
<ul class="simple">
<li>A previous application version introduced a domain error in the form
of a wrong event being emitted from the aggregate</li>
<li>Domain has changed, either from a change in requirements or simply
from a better understanding of the domain</li>
</ul>
<p>EventFlow event upgraders are invoked whenever the event stream is
loaded from the event store. Each event upgrader receives the entire
event stream one event at a time.</p>
<p>A new instance of a event upgrader is created each time an aggregate is
loaded. This enables you to store information from previous events on
the upgrader instance to be used later, e.g. to determine an action to
take on a event or provide additional information for a new event.</p>
<p>Note that the <em>ordering</em> of event upgraders is important as you might
implement two upgraders, one upgrade a event from V1 to V2 and then
another upgrading V2 to V3. EventFlow orders the event upgraders by name
before starting the event upgrade.</p>
<div class="admonition caution">
<p class="first admonition-title">Caution</p>
<p class="last">Be careful when working with event upgraders that return zero or more
than one event, as this have an influence on the aggregate version and
you need to make sure that the aggregate sequence number on upgraded
events are valid in regard to the aggregate history.</p>
</div>
<div class="section" id="example-removing-a-damaged-event">
<h3>Example - removing a damaged event<a class="headerlink" href="#example-removing-a-damaged-event" title="Permalink to this headline">¶</a></h3>
<p>To remove an event, simply check and only return the event if its no the
event you want to remove.</p>
<div class="highlight-c#"><div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">class</span> <span class="nc">DamagedEventRemover</span> <span class="p">:</span> <span class="n">IEventUpgrader</span><span class="p">&lt;</span><span class="n">MyAggregate</span><span class="p">,</span> <span class="n">MyId</span><span class="p">&gt;</span>
<span class="p">{</span>
  <span class="k">public</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">IDomainEvent</span><span class="p">&lt;</span><span class="n">TestAggregate</span><span class="p">,</span> <span class="n">TestId</span><span class="p">&gt;&gt;</span> <span class="n">Upgrade</span><span class="p">(</span>
    <span class="n">IDomainEvent</span><span class="p">&lt;</span><span class="n">TestAggregate</span><span class="p">,</span> <span class="n">TestId</span><span class="p">&gt;</span> <span class="n">domainEvent</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="kt">var</span> <span class="n">damagedEvent</span> <span class="p">=</span> <span class="n">domainEvent</span> <span class="k">as</span> <span class="n">IDomainEvent</span><span class="p">&lt;</span><span class="n">MyAggregate</span><span class="p">,</span> <span class="n">MyId</span><span class="p">,</span> <span class="n">DamagedEvent</span><span class="p">&gt;;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">damagedEvent</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">yield</span> <span class="k">return</span> <span class="n">domainEvent</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="example-replace-event">
<h3>Example - replace event<a class="headerlink" href="#example-replace-event" title="Permalink to this headline">¶</a></h3>
<p>To one event to another, you should use the
<code class="docutils literal"><span class="pre">IDomainEventFactory.Upgrade</span></code> to help migrate meta data and create the
new event.</p>
<div class="highlight-c#"><div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">class</span> <span class="nc">UpgradeMyEventV1ToMyEventV2</span> <span class="p">:</span> <span class="n">IEventUpgrader</span><span class="p">&lt;</span><span class="n">MyAggregate</span><span class="p">,</span> <span class="n">MyId</span><span class="p">&gt;</span>
<span class="p">{</span>
  <span class="k">private</span> <span class="k">readonly</span> <span class="n">IDomainEventFactory</span> <span class="n">_domainEventFactory</span><span class="p">;</span>

  <span class="k">public</span> <span class="nf">UpgradeTestEventV1ToTestEventV2</span><span class="p">(</span><span class="n">IDomainEventFactory</span> <span class="n">domainEventFactory</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">_domainEventFactory</span> <span class="p">=</span> <span class="n">domainEventFactory</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">public</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">IDomainEvent</span><span class="p">&lt;</span><span class="n">TestAggregate</span><span class="p">,</span> <span class="n">TestId</span><span class="p">&gt;&gt;</span> <span class="n">Upgrade</span><span class="p">(</span>
    <span class="n">IDomainEvent</span><span class="p">&lt;</span><span class="n">TestAggregate</span><span class="p">,</span> <span class="n">TestId</span><span class="p">&gt;</span> <span class="n">domainEvent</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="kt">var</span> <span class="n">myEventV1</span> <span class="p">=</span> <span class="n">domainEvent</span> <span class="k">as</span> <span class="n">IDomainEvent</span><span class="p">&lt;</span><span class="n">MyAggregate</span><span class="p">,</span> <span class="n">MyId</span><span class="p">,</span> <span class="n">MyEventV1</span><span class="p">&gt;;</span>
    <span class="k">yield</span> <span class="k">return</span> <span class="n">myEventV1</span> <span class="p">==</span> <span class="k">null</span>
      <span class="p">?</span> <span class="n">domainEvent</span>
      <span class="p">:</span> <span class="n">_domainEventFactory</span><span class="p">.</span><span class="n">Upgrade</span><span class="p">&lt;</span><span class="n">MyAggregate</span><span class="p">,</span> <span class="n">MyId</span><span class="p">&gt;(</span>
        <span class="n">domainEvent</span><span class="p">,</span> <span class="k">new</span> <span class="n">MyEventV2</span><span class="p">());</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="toctree-wrapper compound">
<span id="document-EventStore"></span><div class="section" id="event-stores">
<span id="eventstores"></span><h2>Event stores<a class="headerlink" href="#event-stores" title="Permalink to this headline">¶</a></h2>
<p>By default EventFlow uses a in-memory event store. But EventFlow provides
support for alternatives.</p>
<ul class="simple">
<li><a class="reference internal" href="#eventstore-inmemory"><span class="std std-ref">In-memory</span></a> (for test)</li>
<li><a class="reference internal" href="#eventstore-mssql"><span class="std std-ref">Microsoft SQL Server</span></a></li>
<li><a class="reference internal" href="#eventstore-files"><span class="std std-ref">Files</span></a> (for test)</li>
</ul>
<div class="section" id="in-memory">
<span id="eventstore-inmemory"></span><h3>In-memory<a class="headerlink" href="#in-memory" title="Permalink to this headline">¶</a></h3>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p class="last">In-memory event store shouldn&#8217;t be used for production environments, only for tests.</p>
</div>
<p>Using the in-memory event store is easy as its enabled by default, no need
to do anything.</p>
</div>
<div class="section" id="mssql-event-store">
<span id="eventstore-mssql"></span><h3>MSSQL event store<a class="headerlink" href="#mssql-event-store" title="Permalink to this headline">¶</a></h3>
<p>See <a class="reference internal" href="index.html#setup-mssql"><span class="std std-ref">MSSQL setup</span></a> for details on how to get started
using Microsoft SQL Server in EventFlow.</p>
<p>Configure EventFlow to use MSSQL as event store, simply add the
<code class="docutils literal"><span class="pre">UseMssqlEventStore()</span></code> as shown here.</p>
<div class="highlight-c#"><div class="highlight"><pre><span></span><span class="n">IRootResolver</span> <span class="n">rootResolver</span> <span class="p">=</span> <span class="n">EventFlowOptions</span><span class="p">.</span><span class="n">New</span>
  <span class="p">...</span>
  <span class="p">.</span><span class="n">UseMssqlEventStore</span><span class="p">()</span>
  <span class="p">...</span>
  <span class="p">.</span><span class="n">CreateResolver</span><span class="p">();</span>
</pre></div>
</div>
<div class="section" id="create-and-migrate-required-mssql-databases">
<h4>Create and migrate required MSSQL databases<a class="headerlink" href="#create-and-migrate-required-mssql-databases" title="Permalink to this headline">¶</a></h4>
<p>Before you can use the MSSQL event store, the required database and
tables must be created. The database specified in your MSSQL connection
will <em>not</em> be automatically created, you have to do this yourself.</p>
<p>To make EventFlow create the required tables, execute the following
code.</p>
<div class="highlight-c#"><div class="highlight"><pre><span></span><span class="kt">var</span> <span class="n">msSqlDatabaseMigrator</span> <span class="p">=</span> <span class="n">rootResolver</span><span class="p">.</span><span class="n">Resolve</span><span class="p">&lt;</span><span class="n">IMsSqlDatabaseMigrator</span><span class="p">&gt;();</span>
<span class="n">EventFlowEventStoresMsSql</span><span class="p">.</span><span class="n">MigrateDatabase</span><span class="p">(</span><span class="n">msSqlDatabaseMigrator</span><span class="p">);</span>
</pre></div>
</div>
<p>You should do this either on application start or preferably upon
application install or update, e.g., when the web site is installed.</p>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p class="last">If you utilize user permission in your application, then you
need to grant the event writer access to the user defined table type
<code class="docutils literal"><span class="pre">eventdatamodel_list_type</span></code>. EventFlow uses this type to pass entire
batches of events to the database.</p>
</div>
</div>
</div>
<div class="section" id="files">
<span id="eventstore-files"></span><h3>Files<a class="headerlink" href="#files" title="Permalink to this headline">¶</a></h3>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p class="last">Files event shouldn&#8217;t be used for production environments, only for tests.</p>
</div>
<p>The file based event store is useful if you have a set of events that represents
a certain scenario and would like to create a test that verifies that the domain
handles it correctly.</p>
<p>To use the file based event store, simply invoke <code class="docutils literal"><span class="pre">.UseFilesEventStore`(&quot;...&quot;)</span></code>
with the path containing the files.</p>
<div class="highlight-c#"><div class="highlight"><pre><span></span><span class="kt">var</span> <span class="n">storePath</span> <span class="p">=</span> <span class="s">@&quot;c:\eventstore&quot;</span>
<span class="kt">var</span> <span class="n">rootResolver</span> <span class="p">=</span> <span class="n">EventFlowOptions</span><span class="p">.</span><span class="n">New</span>
  <span class="p">...</span>
  <span class="p">.</span><span class="n">UseFilesEventStore</span><span class="p">(</span><span class="n">FilesEventStoreConfiguration</span><span class="p">.</span><span class="n">Create</span><span class="p">(</span><span class="n">storePath</span><span class="p">))</span>
  <span class="p">...</span>
  <span class="p">.</span><span class="n">CreateResolver</span><span class="p">();</span>
</pre></div>
</div>
</div>
</div>
<span id="document-ReadStores"></span><div class="section" id="read-model-stores">
<span id="read-stores"></span><h2>Read model stores<a class="headerlink" href="#read-model-stores" title="Permalink to this headline">¶</a></h2>
<p>In order to create query handlers that perform and enable them search
across multiple fields, read models or projections are used.</p>
<p>To get started you can use the built-in in-memory read model store, but
EventFlow supports a few others as well.</p>
<ul class="simple">
<li><a class="reference internal" href="#read-store-inmemory"><span class="std std-ref">In-memory</span></a></li>
<li><a class="reference internal" href="#read-store-mssql"><span class="std std-ref">Microsoft SQL Server</span></a></li>
<li><a class="reference internal" href="#read-store-elasticsearch"><span class="std std-ref">Elasticsearch</span></a></li>
</ul>
<div class="section" id="creating-read-models">
<h3>Creating read models<a class="headerlink" href="#creating-read-models" title="Permalink to this headline">¶</a></h3>
<p>Read models are a flattened view of a subset or all aggregate domain
events created specifically for efficient queries.</p>
<p>Here&#8217;s a simple example of how a read model for doing searches for
usernames could look. The read model handles the <code class="docutils literal"><span class="pre">UserCreated</span></code> domain
event to get the username and user ID.</p>
<div class="highlight-c#"><div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">class</span> <span class="nc">UserReadModel</span> <span class="p">:</span> <span class="n">IReadModel</span><span class="p">,</span>
  <span class="n">IAmReadModelFor</span><span class="p">&lt;</span><span class="n">UserAggregate</span><span class="p">,</span> <span class="n">UserId</span><span class="p">,</span> <span class="n">UserCreated</span><span class="p">&gt;</span>
<span class="p">{</span>
  <span class="k">public</span> <span class="kt">string</span> <span class="n">UserId</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
  <span class="k">public</span> <span class="kt">string</span> <span class="n">Username</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

  <span class="k">public</span> <span class="k">void</span> <span class="nf">Apply</span><span class="p">(</span>
    <span class="n">IReadModelContext</span> <span class="n">context</span><span class="p">,</span>
    <span class="n">IDomainEvent</span><span class="p">&lt;</span><span class="n">UserAggregate</span><span class="p">,</span> <span class="n">UserId</span><span class="p">,</span> <span class="n">UserCreated</span><span class="p">&gt;</span> <span class="n">domainEvent</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">UserId</span> <span class="p">=</span> <span class="n">domainEvent</span><span class="p">.</span><span class="n">AggregateIdentity</span><span class="p">.</span><span class="n">Value</span><span class="p">;</span>
    <span class="n">Username</span> <span class="p">=</span> <span class="n">domainEvent</span><span class="p">.</span><span class="n">AggregateEvent</span><span class="p">.</span><span class="n">Username</span><span class="p">.</span><span class="n">Value</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The read model applies all <code class="docutils literal"><span class="pre">UserCreated</span></code> events and thereby merely saves
the latest value instead of the entire history, which makes it much easier to
store in an efficient manner.</p>
</div>
<div class="section" id="read-model-locators">
<h3>Read model locators<a class="headerlink" href="#read-model-locators" title="Permalink to this headline">¶</a></h3>
<p>Typically the ID of read models are the aggregate identity, but
sometimes this isn&#8217;t the case. Here are some examples.</p>
<ul class="simple">
<li>Items from a collection on the aggregate root</li>
<li>Deterministic ID created from event data</li>
<li>Entity within the aggregate</li>
</ul>
<p>To create read models in these cases, use the EventFlow concept of read
model locators, which is basically a mapping from a domain event to a
read model ID.</p>
<p>As an example, consider if we could add several nicknames to a user. We
might have a domain event called <code class="docutils literal"><span class="pre">UserNicknameAdded</span></code> similar to this.</p>
<div class="highlight-c#"><div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">class</span> <span class="nc">UserNicknameAdded</span> <span class="p">:</span> <span class="n">AggregateEvent</span><span class="p">&lt;</span><span class="n">UserAggregate</span><span class="p">,</span> <span class="n">UserId</span><span class="p">&gt;</span>
<span class="p">{</span>
  <span class="k">public</span> <span class="n">Nickname</span> <span class="n">Nickname</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>We could then create a read model locator that would return the ID for
each nickname we add via the event like this.</p>
<div class="highlight-c#"><div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">class</span> <span class="nc">UserNicknameReadModelLocator</span> <span class="p">:</span> <span class="n">IReadModelLocator</span>
<span class="p">{</span>
  <span class="k">public</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">GetReadModelIds</span><span class="p">(</span><span class="n">IDomainEvent</span> <span class="n">domainEvent</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="kt">var</span> <span class="n">userNicknameAdded</span> <span class="p">=</span> <span class="n">domainEvent</span> <span class="k">as</span>
      <span class="n">IDomainEvent</span><span class="p">&lt;</span><span class="n">UserAggregate</span><span class="p">,</span> <span class="n">UserId</span><span class="p">,</span> <span class="n">UserNicknameAdded</span><span class="p">&gt;;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">userNicknameAdded</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">yield</span> <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">yield</span> <span class="k">return</span> <span class="n">userNicknameAdded</span><span class="p">.</span><span class="n">Nickname</span><span class="p">.</span><span class="n">Id</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>And then use a read model similar to this that represent each nickname.</p>
<div class="highlight-c#"><div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">class</span> <span class="nc">UserNicknameReadModel</span> <span class="p">:</span> <span class="n">IReadModel</span><span class="p">,</span>
  <span class="n">IAmReadModelFor</span><span class="p">&lt;</span><span class="n">UserAggregate</span><span class="p">,</span> <span class="n">UserId</span><span class="p">,</span> <span class="n">UserNicknameAdded</span><span class="p">&gt;</span>
<span class="p">{</span>
  <span class="k">public</span> <span class="kt">string</span> <span class="n">UserId</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
  <span class="k">public</span> <span class="kt">string</span> <span class="n">Nickname</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

  <span class="k">public</span> <span class="k">void</span> <span class="nf">Apply</span><span class="p">(</span>
    <span class="n">IReadModelContext</span> <span class="n">context</span><span class="p">,</span>
    <span class="n">IDomainEvent</span><span class="p">&lt;</span><span class="n">UserAggregate</span><span class="p">,</span> <span class="n">UserId</span><span class="p">,</span> <span class="n">UserCreated</span><span class="p">&gt;</span> <span class="n">domainEvent</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">UserId</span> <span class="p">=</span> <span class="n">domainEvent</span><span class="p">.</span><span class="n">AggregateIdentity</span><span class="p">.</span><span class="n">Value</span><span class="p">;</span>
    <span class="n">Nickname</span> <span class="p">=</span> <span class="n">domainEvent</span><span class="p">.</span><span class="n">AggregateEvent</span><span class="p">.</span><span class="n">Nickname</span><span class="p">.</span><span class="n">Value</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>We could then use this nickname read model to query all the nicknames
for a given user by search for read models that have a specific
<code class="docutils literal"><span class="pre">UserId</span></code>.</p>
</div>
<div class="section" id="read-store-implementations">
<h3>Read store implementations<a class="headerlink" href="#read-store-implementations" title="Permalink to this headline">¶</a></h3>
<p>EventFlow has built-in support for several different read model stores.</p>
<div class="section" id="in-memory">
<span id="read-store-inmemory"></span><h4>In-memory<a class="headerlink" href="#in-memory" title="Permalink to this headline">¶</a></h4>
<p>The in-memory read store is easy to use and easy to configure. All read
models are stored in-memory, so if EventFlow is restarted all read
models are lost.</p>
<p>To configure the in-memory read model store, simply call
<code class="docutils literal"><span class="pre">UseInMemoryReadStoreFor&lt;&gt;</span></code> or <code class="docutils literal"><span class="pre">UseInMemoryReadStoreFor&lt;,&gt;</span></code> with
your read model as the generic argument.</p>
<div class="highlight-c#"><div class="highlight"><pre><span></span><span class="kt">var</span> <span class="n">resolver</span> <span class="p">=</span> <span class="n">EventFlowOptions</span><span class="p">.</span><span class="n">New</span>
  <span class="p">...</span>
  <span class="p">.</span><span class="n">UseInMemoryReadStoreFor</span><span class="p">&lt;</span><span class="n">UserReadModel</span><span class="p">&gt;()</span>
  <span class="p">.</span><span class="n">UseInMemoryReadStoreFor</span><span class="p">&lt;</span><span class="n">UserNicknameReadModel</span><span class="p">,</span><span class="n">UserNicknameReadModelLocator</span><span class="p">&gt;()</span>
  <span class="p">...</span>
  <span class="p">.</span><span class="n">CreateResolver</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="section" id="microsoft-sql-server">
<span id="read-store-mssql"></span><h4>Microsoft SQL Server<a class="headerlink" href="#microsoft-sql-server" title="Permalink to this headline">¶</a></h4>
<p>To configure the MSSQL read model store, simply call
<code class="docutils literal"><span class="pre">UseMssqlReadModel&lt;&gt;</span></code> or <code class="docutils literal"><span class="pre">UseMssqlReadModel&lt;,&gt;</span></code> with your read model
as the generic argument.</p>
<div class="highlight-c#"><div class="highlight"><pre><span></span><span class="kt">var</span> <span class="n">resolver</span> <span class="p">=</span> <span class="n">EventFlowOptions</span><span class="p">.</span><span class="n">New</span>
  <span class="p">...</span>
  <span class="p">.</span><span class="n">UseMssqlReadModel</span><span class="p">&lt;</span><span class="n">UserReadModel</span><span class="p">&gt;()</span>
  <span class="p">.</span><span class="n">UseMssqlReadModel</span><span class="p">&lt;</span><span class="n">UserNicknameReadModel</span><span class="p">,</span><span class="n">UserNicknameReadModelLocator</span><span class="p">&gt;()</span>
  <span class="p">...</span>
  <span class="p">.</span><span class="n">CreateResolver</span><span class="p">();</span>
</pre></div>
</div>
<p>By convention, EventFlow uses the table named <code class="docutils literal"><span class="pre">ReadModel-[CLASS</span> <span class="pre">NAME]</span></code>
as the table to store the read models rows in. If you need to change
this, use the <code class="docutils literal"><span class="pre">Table</span></code> from the
<code class="docutils literal"><span class="pre">System.ComponentModel.DataAnnotations.Schema</span></code> namespace. So in the
above example, the read model <code class="docutils literal"><span class="pre">UserReadModel</span></code> would be stored in a
table called <code class="docutils literal"><span class="pre">ReadModel-UserReadModel</span></code> unless stated otherwise.</p>
<p>To allow EventFlow to find the read models stored, a single column is
required to have the <code class="docutils literal"><span class="pre">MsSqlReadModelIdentityColumn</span></code> attribute. This
will be used to store the read model ID.</p>
<p>You should also create a <code class="docutils literal"><span class="pre">int</span></code> column that has the
<code class="docutils literal"><span class="pre">MsSqlReadModelVersionColumn</span></code> attribute to tell EventFlow which column
is used to store the read model version in.</p>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p class="last">EventFlow expect the read model to exist, and thus any
maintenance of the database schema for the read models must be handled
before EventFlow is initialized. Or, at least before the read models are
used in EventFlow.</p>
</div>
</div>
<div class="section" id="elasticsearch">
<span id="read-store-elasticsearch"></span><h4>Elasticsearch<a class="headerlink" href="#elasticsearch" title="Permalink to this headline">¶</a></h4>
<p>To configure the
<a class="reference external" href="https://www.elastic.co/products/elasticsearch">Elasticsearch</a> read
model store, simply call <code class="docutils literal"><span class="pre">UseElasticsearchReadModel&lt;&gt;</span></code> or
<code class="docutils literal"><span class="pre">UseElasticsearchReadModel&lt;,&gt;</span></code> with your read model as the generic
argument.</p>
<div class="highlight-c#"><div class="highlight"><pre><span></span><span class="kt">var</span> <span class="n">resolver</span> <span class="p">=</span> <span class="n">EventFlowOptions</span><span class="p">.</span><span class="n">New</span>
  <span class="p">...</span>
  <span class="p">.</span><span class="n">ConfigureElasticsearch</span><span class="p">(</span><span class="k">new</span> <span class="n">Uri</span><span class="p">(</span><span class="s">&quot;http://localhost:9200/&quot;</span><span class="p">))</span>
  <span class="p">...</span>
  <span class="p">.</span><span class="n">UseElasticsearchReadModel</span><span class="p">&lt;</span><span class="n">UserReadModel</span><span class="p">&gt;()</span>
  <span class="p">.</span><span class="n">UseElasticsearchReadModel</span><span class="p">&lt;</span><span class="n">UserNicknameReadModel</span><span class="p">,</span><span class="n">UserNicknameReadModelLocator</span><span class="p">&gt;()</span>
  <span class="p">...</span>
  <span class="p">.</span><span class="n">CreateResolver</span><span class="p">();</span>
</pre></div>
</div>
<p>Overloads of <code class="docutils literal"><span class="pre">ConfigureElasticsearch(...)</span></code> is available for
alternative Elasticsearch configurations.</p>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p class="last">Make sure to create any mapping the read model requires in Elasticsearch
<em>before</em> using the read model in EventFlow.</p>
</div>
<p>If EventFlow is requested to <em>purge</em> a specific read model, it does it
by deleting the index. Thus make sure to create one separate index per
read model.</p>
<p>If you want to control the index a specific read model is stored in,
create an implementation of <code class="docutils literal"><span class="pre">IReadModelDescriptionProvider</span></code> and
register it in the <a class="reference external" href="./Customize.md">EventFlow IoC</a>.</p>
</div>
</div>
</div>
</div>
<div class="toctree-wrapper compound">
<span id="document-MSSQL"></span><div class="section" id="microsoft-sql-server">
<span id="setup-mssql"></span><h2>Microsoft SQL Server<a class="headerlink" href="#microsoft-sql-server" title="Permalink to this headline">¶</a></h2>
<p>To setup EventFlow Microsoft SQL Server integration, install the NuGet
package <code class="docutils literal"><span class="pre">EventFlow.MsSql</span></code> and add this to your EventFlow setup.</p>
<div class="highlight-c#"><div class="highlight"><pre><span></span><span class="n">IRootResolver</span> <span class="n">rootResolver</span> <span class="p">=</span> <span class="n">EventFlowOptions</span><span class="p">.</span><span class="n">New</span>
  <span class="p">.</span><span class="n">ConfigureMsSql</span><span class="p">(</span><span class="n">MsSqlConfiguration</span><span class="p">.</span><span class="n">New</span>
    <span class="p">.</span><span class="n">SetConnectionString</span><span class="p">(</span><span class="s">@&quot;Server=.\SQLEXPRESS;Database=MyApp;User Id=sa;Password=???&quot;</span><span class="p">))</span>
  <span class="p">...</span>
  <span class="p">.</span><span class="n">CreateResolver</span><span class="p">();</span>
</pre></div>
</div>
<p>After setting up Microsoft SQL Server support in EventFlow, you can
continue to configure it.</p>
<ul class="simple">
<li><a class="reference internal" href="index.html#eventstore-mssql"><span class="std std-ref">Event store</span></a></li>
<li><a class="reference internal" href="index.html#read-store-mssql"><span class="std std-ref">Read model store</span></a></li>
</ul>
</div>
<span id="document-RabbitMQ"></span><div class="section" id="rabbitmq">
<span id="setup-rabbitmq"></span><h2>RabbitMQ<a class="headerlink" href="#rabbitmq" title="Permalink to this headline">¶</a></h2>
<p>To setup EventFlow <a class="reference external" href="https://www.rabbitmq.com/">RabbitMQ</a> integration, install the NuGet package
<code class="docutils literal"><span class="pre">EventFlow.RabbitMQ</span></code> and add this to your EventFlow setup.</p>
<div class="highlight-c#"><div class="highlight"><pre><span></span><span class="kt">var</span> <span class="n">uri</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Uri</span><span class="p">(</span><span class="s">&quot;amqp://localhost&quot;</span><span class="p">);</span>

<span class="kt">var</span> <span class="n">resolver</span> <span class="p">=</span> <span class="n">EventFlowOptions</span><span class="p">.</span><span class="n">with</span>
  <span class="p">.</span><span class="n">PublishToRabbitMq</span><span class="p">(</span><span class="n">RabbitMqConfiguration</span><span class="p">.</span><span class="n">With</span><span class="p">(</span><span class="n">uri</span><span class="p">))</span>
  <span class="p">...</span>
  <span class="p">.</span><span class="n">CreateResolver</span><span class="p">();</span>
</pre></div>
</div>
<p>After setting up RabbitMQ support in EventFlow, you can continue to configure it.</p>
<ul class="simple">
<li><a class="reference internal" href="index.html#subscribers-rabbitmq"><span class="std std-ref">Publish all domain events</span></a></li>
</ul>
</div>
</div>
<div class="toctree-wrapper compound">
<span id="document-Configuration"></span><div class="section" id="configuration">
<span id="id1"></span><h2>Configuration<a class="headerlink" href="#configuration" title="Permalink to this headline">¶</a></h2>
<p>EventFlow can be configured by invoking <code class="docutils literal"><span class="pre">eventFlowOptions.Configure(c</span> <span class="pre">=&gt;</span> <span class="pre">...)`</span></code>, or
by providing a custom implementation of <code class="docutils literal"><span class="pre">IEventFlowConfiguration</span></code>.</p>
<p>Each configuration is described below. The default values should be good enough
for most production setups.</p>
<div class="highlight-c#"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">interface</span> <span class="n">IEventFlowConfiguration</span>
<span class="p">{</span>
    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// Number of events to load from the event persistance when read models</span>
    <span class="c1">/// are populated.</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="c1">/// &lt;remarks&gt;Defaults to 200&lt;/remarks&gt;</span>
    <span class="kt">int</span> <span class="n">PopulateReadModelEventPageSize</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>

    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// Use by &lt;c&gt;OptimisticConcurrencyRetryStrategy&lt;/c&gt; to determine the number</span>
    <span class="c1">/// of retries when an optimistic concurrency exceptions is thrown from the</span>
    <span class="c1">/// event persistance.</span>
    <span class="c1">/// </span>
    <span class="c1">/// If more fine grained control of is needed, a custom implementation of</span>
    <span class="c1">/// &lt;c&gt;IOptimisticConcurrencyRetryStrategy&lt;/c&gt; should be provided.</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="c1">/// &lt;remarks&gt;Defaults to 4&lt;/remarks&gt;</span>
    <span class="kt">int</span> <span class="n">NumberOfRetriesOnOptimisticConcurrencyExceptions</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>

    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// Use by &lt;c&gt;OptimisticConcurrencyRetryStrategy&lt;/c&gt; to determine the delay</span>
    <span class="c1">/// between retries when an optimistic concurrency exceptions is thrown from the</span>
    <span class="c1">/// event persistance.</span>
    <span class="c1">/// </span>
    <span class="c1">/// If more fine grained control of is needed, a custom implementation of</span>
    <span class="c1">/// &lt;c&gt;IOptimisticConcurrencyRetryStrategy&lt;/c&gt; should be provided.</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="c1">/// &lt;remarks&gt;Defaults to 100 ms&lt;/remarks&gt;</span>
    <span class="n">TimeSpan</span> <span class="n">DelayBeforeRetryOnOptimisticConcurrencyExceptions</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>

    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// Should EventFlow throw exceptions thrown by subscibers when publishing</span>
    <span class="c1">/// domain events.</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="c1">/// &lt;remarks&gt;Defaults to false&lt;/remarks&gt;</span>
    <span class="kt">bool</span> <span class="n">ThrowSubscriberExceptions</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
<span id="document-IoC"></span><div class="section" id="ioc-container">
<span id="id1"></span><h2>IoC container<a class="headerlink" href="#ioc-container" title="Permalink to this headline">¶</a></h2>
<p>EventFlow has a custom minimal IoC container implementation, but before
using EventFlow in a production environment, its recommended to change
to <a class="reference external" href="https://autofac.org/">Autofac</a> or provide another.</p>
<div class="section" id="autofac">
<h3>Autofac<a class="headerlink" href="#autofac" title="Permalink to this headline">¶</a></h3>
<p>EventFlow provides the NuGet package <code class="docutils literal"><span class="pre">EventFlow.Autofac</span></code> that allows
you to set the internal <code class="docutils literal"><span class="pre">ContainerBuilder</span></code> used during EventFlow
initialization.</p>
<p>Pass the <code class="docutils literal"><span class="pre">ContainerBuilder</span></code> to EventFlow and call
<code class="docutils literal"><span class="pre">CreateContainer()</span></code> when configuration is done to create the
container.</p>
<div class="highlight-c#"><div class="highlight"><pre><span></span><span class="kt">var</span> <span class="n">containerBuilder</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ContainerBuilder</span><span class="p">();</span>

<span class="kt">var</span> <span class="n">container</span> <span class="p">=</span> <span class="n">EventFlowOptions</span><span class="p">.</span><span class="n">With</span>
  <span class="p">.</span><span class="n">UseAutofacContainerBuilder</span><span class="p">(</span><span class="n">containerBuilder</span><span class="p">)</span> <span class="c1">// Must be the first line!</span>
  <span class="p">...</span>
  <span class="p">.</span><span class="n">CreateContainer</span><span class="p">();</span>
</pre></div>
</div>
</div>
</div>
<span id="document-Log"></span><div class="section" id="log">
<span id="id1"></span><h2>Log<a class="headerlink" href="#log" title="Permalink to this headline">¶</a></h2>
<p>The default log implementation of EventFLow logs to the console. To have another
behavior, register an implementation of <code class="docutils literal"><span class="pre">ILog</span></code>, use the <code class="docutils literal"><span class="pre">Log</span></code> as a base class
to make the implementation easier.</p>
</div>
<span id="document-Snapshots"></span><div class="section" id="snapshots">
<span id="id1"></span><h2>Snapshots<a class="headerlink" href="#snapshots" title="Permalink to this headline">¶</a></h2>
<p>When working with long-lived aggregates, performance when loading
aggregates, and thereby making changes to them, becomes a real concern.
Consider aggregates that are comprised of several thousands of events,
some of which needs to go through a rigorous
<a class="reference external" href="./EventUpgrade.md">update</a> process before they are applied to the
aggregates.</p>
<p>EventFlow support aggregate snapshots, which is basically a capture of
the entire aggregate state every few events. So instead of loading the
entire aggregate event history, the latest snapshot is loaded, then
applied to the aggregate and then the remaining events that wasn&#8217;t
captured in the snapshot.</p>
<p>To configure an aggregate root to support snapshots, inherit from
<code class="docutils literal"><span class="pre">SnapshotAggregateRoot&lt;,,&gt;</span></code> and define a serializable snapshot type
that is marked with the <code class="docutils literal"><span class="pre">ISnapshot</span></code> interface.</p>
<div class="highlight-c#"><div class="highlight"><pre><span></span><span class="na">[SnapshotVersion(&quot;user&quot;, 1)]</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">UserSnapshot</span> <span class="p">:</span> <span class="n">ISnapshot</span>
<span class="p">{</span>
  <span class="p">...</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">UserAggregate</span> <span class="p">:</span>
  <span class="n">SnapshotAggregateRoot</span><span class="p">&lt;</span><span class="n">UserAggregate</span><span class="p">,</span> <span class="n">UserId</span><span class="p">,</span> <span class="n">UserSnapshot</span><span class="p">&gt;</span>
<span class="p">{</span>
  <span class="k">protected</span> <span class="k">override</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">UserSnapshot</span><span class="p">&gt;</span> <span class="n">CreateSnapshotAsync</span><span class="p">(</span>
    <span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">// Create a UserSnapshot based on the current aggregate state</span>
    <span class="p">...</span>
  <span class="p">}</span>

  <span class="k">protected</span> <span class="k">override</span> <span class="n">Task</span> <span class="nf">LoadSnapshotAsync</span><span class="p">(</span>
    <span class="n">UserSnapshot</span> <span class="n">snapshot</span><span class="p">,</span>
    <span class="n">ISnapshotMetadata</span> <span class="n">metadata</span><span class="p">,</span>
    <span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">// Load the UserSnapshot into the current aggregate</span>
    <span class="p">...</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>When using aggregate snapshots there are several important details to
remember</p>
<ul class="simple">
<li>Aggregates must not make any assumptions regarding the existence of
snapshots</li>
<li>Aggregates must not assume that if a snapshots are created with
increasing aggregate sequence numbers</li>
<li>Snapshots must be created in such a way, that the represent the
entire history up to the point of snapshot creation</li>
</ul>
<div class="section" id="snapshot-strategy">
<h3>Snapshot strategy<a class="headerlink" href="#snapshot-strategy" title="Permalink to this headline">¶</a></h3>
<p>When implementing an aggregate root that inherits from
<code class="docutils literal"><span class="pre">SnapshotAggregateRoot&lt;,,&gt;</span></code>, you need to pass the base class an
implementation of <code class="docutils literal"><span class="pre">ISnapshotStrategy</span></code>. The strategy is used to
determine when a snapshot should be created, e.g. every 100 events.</p>
<p>EventFlow ships with two that should be enough for most purposes as they
can be configured.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">SnapshotEveryFewVersionsStrategy:</span></code> Snapshots are created after a
predefined number of events, the default is <code class="docutils literal"><span class="pre">100</span></code>, but another
frequency can be specified</li>
<li><code class="docutils literal"><span class="pre">SnapshotRandomlyStrategy:</span></code> Snapshots are created randomly with a
predefined chance, the default is <code class="docutils literal"><span class="pre">1%</span></code>, but another can be
specified</li>
</ul>
</div>
<div class="section" id="upgrading-snapshots">
<h3>Upgrading snapshots<a class="headerlink" href="#upgrading-snapshots" title="Permalink to this headline">¶</a></h3>
<p>As an application grows over time, the data required to be stored within
a snapshots will change. Either because some become obsolete or merely
because a better way of storing aggregate state is found. If this
happens, the snapshots persisted in the snapshot store could potentially
become useless as aggregates are unable to apply them. The easy solution
would be to make change-by-addition and make sure that the old snapshots
can be desterilized into the new version.</p>
<p>EventFlow provides an alternative solution, which is basically allowing
developers to upgrade snapshots similar to how <a class="reference external" href="./EventUpgrade.md">events are
upgraded</a>.</p>
<p>Lets say we have an application that has developed three snapshots
versions over time.</p>
<div class="highlight-c#"><div class="highlight"><pre><span></span><span class="na">[SnapshotVersion(&quot;user&quot;, 1)]</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">UserSnapshotV1</span> <span class="p">:</span> <span class="n">ISnapshot</span>
<span class="p">{</span>
  <span class="p">...</span>
<span class="p">}</span>

<span class="na">[SnapshotVersion(&quot;user&quot;, 2)]</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">UserSnapshotV1</span> <span class="p">:</span> <span class="n">ISnapshot</span>
<span class="p">{</span>
  <span class="p">...</span>
<span class="p">}</span>

<span class="na">[SnapshotVersion(&quot;user&quot;, 3)]</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">UserSnapshot</span> <span class="p">:</span> <span class="n">ISnapshot</span>
<span class="p">{</span>
  <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Note how version three of the <code class="docutils literal"><span class="pre">UserAggregate</span></code> snapshot is called
<code class="docutils literal"><span class="pre">UserSnapshot</span></code> and not <code class="docutils literal"><span class="pre">UserSnapshotV3</span></code>, its basically to help
developers tell which snapshot version is the current one.</p>
<p>Remember to add the <code class="docutils literal"><span class="pre">[SnapshotVersion]</span></code> attribute as it enables
control of the snapshot definition name. If left out, EventFlow will
make a guess, which will be tied to the name of the class type.</p>
<p>The next step will be to implement upgraders, or mappers, that can
upgrade one snapshot to another.</p>
<div class="highlight-c#"><div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">class</span> <span class="nc">UserSnapshotV1ToV2Upgrader</span> <span class="p">:</span>
  <span class="n">ISnapshotUpgrader</span><span class="p">&lt;</span><span class="n">UserSnapshotV1</span><span class="p">,</span> <span class="n">UserSnapshotV2</span><span class="p">&gt;</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">UserSnapshotV2</span><span class="p">&gt;</span> <span class="n">UpgradeAsync</span><span class="p">(</span>
      <span class="n">UserSnapshotV1</span> <span class="n">userSnapshotV1</span><span class="p">,</span>
      <span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="c1">// Map from V1 to V2 and return</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">UserSnapshotV2ToV3Upgrader</span> <span class="p">:</span>
  <span class="n">ISnapshotUpgrader</span><span class="p">&lt;</span><span class="n">UserSnapshotV2</span><span class="p">,</span> <span class="n">UserSnapshot</span><span class="p">&gt;</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">UserSnapshot</span><span class="p">&gt;</span> <span class="n">UpgradeAsync</span><span class="p">(</span>
      <span class="n">UserSnapshotV2</span> <span class="n">userSnapshotV2</span><span class="p">,</span>
      <span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="c1">// Map from V2 to V3 and return</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The snapshot types and upgraders then only needs to be registered in
EventFlow.</p>
<div class="highlight-c#"><div class="highlight"><pre><span></span><span class="kt">var</span> <span class="n">resolver</span> <span class="p">=</span> <span class="n">EventFlowOptions</span><span class="p">.</span><span class="n">New</span>
  <span class="p">...</span>
  <span class="p">.</span><span class="n">AddSnapshotUpgraders</span><span class="p">(</span><span class="n">myAssembly</span><span class="p">)</span>
  <span class="p">.</span><span class="n">AddSnapshots</span><span class="p">(</span><span class="n">myAssembly</span><span class="p">)</span>
  <span class="p">...</span>
  <span class="p">.</span><span class="n">CreateResolver</span><span class="p">();</span>
</pre></div>
</div>
<p>Now, when ever a snapshot is loaded from the snapshot store, its
automatically upgraded to the latest version and the aggregate only
needs to concern itself with the latest version.</p>
</div>
<div class="section" id="snapshot-store-implementations">
<h3>Snapshot store implementations<a class="headerlink" href="#snapshot-store-implementations" title="Permalink to this headline">¶</a></h3>
<p>EventFlow has built-in support for some snapshot stores (more <em>will</em> be
implemented).</p>
<div class="section" id="null-or-none">
<h4>Null (or none)<a class="headerlink" href="#null-or-none" title="Permalink to this headline">¶</a></h4>
<p>The default implementation used by EventFlow does absolutely nothing
besides logging a warning if used. It exist only to help developers to
select a proper snapshot store. Making in-memory the default
implementation could present problems if snapshots were configured, but
the snapshot store configuration forgotten.</p>
</div>
<div class="section" id="in-memory">
<h4>In-memory<a class="headerlink" href="#in-memory" title="Permalink to this headline">¶</a></h4>
<p>For testing, or small applications, the in-memory snapshot store is
configured by merely calling <code class="docutils literal"><span class="pre">UseInMemorySnapshotStore()</span></code>.</p>
<div class="highlight-c#"><div class="highlight"><pre><span></span><span class="kt">var</span> <span class="n">resolver</span> <span class="p">=</span> <span class="n">EventFlowOptions</span><span class="p">.</span><span class="n">New</span>
  <span class="p">...</span>
  <span class="p">.</span><span class="n">UseInMemorySnapshotStore</span><span class="p">()</span>
  <span class="p">...</span>
  <span class="p">.</span><span class="n">CreateResolver</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="section" id="microsoft-sql-server">
<h4>Microsoft SQL Server<a class="headerlink" href="#microsoft-sql-server" title="Permalink to this headline">¶</a></h4>
<p>To use the MSSQL snapshot store you need to install the NuGet package
<code class="docutils literal"><span class="pre">EventFlow.MsSql</span></code>.</p>
<div class="section" id="configuration">
<h5>Configuration<a class="headerlink" href="#configuration" title="Permalink to this headline">¶</a></h5>
<p>Configure the MSSQL connection and snapshot store as shown here.</p>
<div class="highlight-c#"><div class="highlight"><pre><span></span><span class="kt">var</span> <span class="n">rootResolver</span> <span class="p">=</span> <span class="n">EventFlowOptions</span><span class="p">.</span><span class="n">New</span>
  <span class="p">...</span>
  <span class="p">.</span><span class="n">ConfigureMsSql</span><span class="p">(</span><span class="n">MsSqlConfiguration</span><span class="p">.</span><span class="n">New</span>
    <span class="p">.</span><span class="n">SetConnectionString</span><span class="p">(</span><span class="s">@&quot;Server=.\SQLEXPRESS;Database=MyApp;User Id=sa;Password=???&quot;</span><span class="p">))</span>
  <span class="p">.</span><span class="n">UseMsSqlSnapshotStore</span><span class="p">()</span>
  <span class="p">...</span>
  <span class="p">.</span><span class="n">CreateResolver</span><span class="p">();</span>
</pre></div>
</div>
<p>Note that if you already use MSSQL for event- or read model store, you
only need to invoke the <code class="docutils literal"><span class="pre">ConfigureMsSql</span></code> extension <em>once</em>.</p>
</div>
<div class="section" id="create-and-migrate-required-mssql-databases">
<h5>Create and migrate required MSSQL databases<a class="headerlink" href="#create-and-migrate-required-mssql-databases" title="Permalink to this headline">¶</a></h5>
<p>Before you can use the MSSQL snapshot store, the required database and
tables must be created. The database specified in your MSSQL connection
<em>will not</em> be automatically created, you have to do this yourself.</p>
<p>To make EventFlow create the required tables, execute the following
code.</p>
<div class="highlight-c#"><div class="highlight"><pre><span></span><span class="kt">var</span> <span class="n">msSqlDatabaseMigrator</span> <span class="p">=</span> <span class="n">rootResolver</span><span class="p">.</span><span class="n">Resolve</span><span class="p">&lt;</span><span class="n">IMsSqlDatabaseMigrator</span><span class="p">&gt;();</span>
<span class="n">EventFlowSnapshotStoresMsSql</span><span class="p">.</span><span class="n">MigrateDatabase</span><span class="p">(</span><span class="n">msSqlDatabaseMigrator</span><span class="p">);</span>
</pre></div>
</div>
<p>You should do this either on application start or preferably upon
application install or update, e.g., when the web site is installed.</p>
</div>
</div>
<div class="section" id="custom">
<h4>Custom<a class="headerlink" href="#custom" title="Permalink to this headline">¶</a></h4>
<p>If none of the above stores are adequate, a custom implementation is
possible by implementing the interface <code class="docutils literal"><span class="pre">ISnapshotPersistence</span></code>.
However, there are some rules that the snapshot persistence store <em>must</em>
follow.</p>
<ul class="simple">
<li>Its valid to store snapshots in any order, e.g. first version 3 then
2</li>
<li>Its valid to overwrite existing snapshots version, e.g. storing
version 3 then version 3 again</li>
<li>Fallback to old snapshots is allowed</li>
</ul>
</div>
</div>
</div>
<span id="document-Customize"></span><div class="section" id="customize">
<h2>Customize<a class="headerlink" href="#customize" title="Permalink to this headline">¶</a></h2>
<p>If you are looking for how to configure EventFlow, look at the
<a class="reference internal" href="index.html#configuration"><span class="std std-ref">configuration</span></a> documentation.</p>
<p>When ever EventFlow doesn&#8217;t meet your needs, e.g. if you want to collect
statistics on each command execution time, you can customize EventFlow.</p>
<p>Basically EventFlow relies on an IoC container to allow developers to
customize the different parts of EventFlow.</p>
<p>Note: Read the section &#8220;Changing IoC container&#8221; for details on how to
change the IoC container used if you have specific needs like e.g.
integrating EventFlow into an Owin application.</p>
<p>You have two options for when you want to customize EventFlow</p>
<ul class="simple">
<li>Decorate an implementation</li>
<li>Replace an implementation</li>
</ul>
<div class="section" id="decorating-implementations">
<span id="ioc-decorator"></span><h3>Decorating implementations<a class="headerlink" href="#decorating-implementations" title="Permalink to this headline">¶</a></h3>
<p>In the case of collecting statistics, you might want to wrap the
existing <code class="docutils literal"><span class="pre">ICommandBus</span></code> with a decorator class the can collect
statistics on command execution times.</p>
<div class="highlight-c#"><div class="highlight"><pre><span></span><span class="k">void</span> <span class="nf">ConfigureEventFlow</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">var</span> <span class="n">resolver</span> <span class="p">=</span> <span class="n">EventFlowOptions</span><span class="p">.</span><span class="k">new</span>
    <span class="p">.</span><span class="n">RegisterServices</span><span class="p">(</span><span class="n">DecorateCommandBus</span><span class="p">)</span>
    <span class="p">...</span>
    <span class="p">.</span><span class="n">CreateResolver</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">void</span> <span class="nf">DecorateCommandBus</span><span class="p">(</span><span class="n">IServiceRegistration</span> <span class="n">sr</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">sr</span><span class="p">.</span><span class="n">Decorate</span><span class="p">&lt;</span><span class="n">ICommandBus</span><span class="p">&gt;((</span><span class="n">r</span><span class="p">,</span> <span class="n">cb</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="n">StatsCommandBus</span><span class="p">(</span><span class="n">sb</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">class</span> <span class="nc">StatsCommandBus</span> <span class="p">:</span> <span class="n">ICommandBus</span>
<span class="p">{</span>
  <span class="k">private</span> <span class="k">readonly</span> <span class="n">_internalCommandBus</span><span class="p">;</span>

  <span class="k">public</span> <span class="nf">StatsCommandBus</span><span class="p">(</span><span class="n">ICommandBus</span> <span class="n">commandBus</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">_internalCommandBus</span> <span class="p">=</span> <span class="n">commandBus</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// Here follow implementations of ICommandBus that call the</span>
  <span class="c1">// internal command bus and logs statistics</span>
  <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="registering-new-implementations">
<h3>Registering new implementations<a class="headerlink" href="#registering-new-implementations" title="Permalink to this headline">¶</a></h3>
<p>The more drastic step is to completely replace an implementation. For
this you use the <code class="docutils literal"><span class="pre">Register(...)</span></code> and related methods on
<code class="docutils literal"><span class="pre">IServiceRegistration</span></code> instead of the <code class="docutils literal"><span class="pre">Decorate(...)</span></code> method.</p>
</div>
</div>
<span id="document-ValueObjects"></span><div class="section" id="event-serialization-and-value-objects">
<span id="value-objects"></span><h2>Event serialization and value objects<a class="headerlink" href="#event-serialization-and-value-objects" title="Permalink to this headline">¶</a></h2>
<p>One of the important parts the creating a event sourced application, is
to ensure that you always can read your event streams. It seems simple
enough, but it is a problem, especially for with large applications that
undergo refactoring or domain changes.</p>
<p>The basic idea is to store events in a structure that&#8217;s easy to access
and migrate if the need should arise. EventFlow, like many other event
sourced systems, stores its event using JSON.</p>
<div class="section" id="making-pretty-and-clean-json">
<h3>Making pretty and clean JSON<a class="headerlink" href="#making-pretty-and-clean-json" title="Permalink to this headline">¶</a></h3>
<p>You might wonder &#8220;but, why?&#8221;, and the reason is somewhat similar to the
reasoning behind <a class="reference external" href="https://en.wikipedia.org/wiki/Semantic_URL">semantic
URLs</a>.</p>
<p>Consider the following value object used to validate and contain
usernames in an application.</p>
<div class="highlight-c#"><div class="highlight"><pre><span></span>public class Username
{
  public string Value { get; }

  public Username(string value)
  {
    if (string.IsNullOrEmpty(value) || value.Length &lt;= 4)
    {
      throw DomainError.With($&quot;Invalid username &#39;{value}&#39;&quot;);
    }

    Value = value;
  }
}
</pre></div>
</div>
<p>First we do some cleanup and re-write it using EventFlows
<code class="docutils literal"><span class="pre">SingleValueObject&lt;&gt;</span></code>.</p>
<div class="highlight-c#"><div class="highlight"><pre><span></span>public class Username : SingleValueObject&lt;string&gt;
{
  public Username(string value) : base(value)
  {
    if (string.IsNullOrEmpty(value) || value.Length &lt;= 4)
    {
      throw DomainError.With($&quot;Invalid username &#39;{value}&#39;&quot;);
    }
  }
}
</pre></div>
</div>
<p>Now it looks simple and we might think we can use this value object
directly in our domain events. We could, but the resulting JSON will
look like this.</p>
<div class="code json highlight-default"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;Username&quot;</span> <span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;Value&quot;</span><span class="p">:</span> <span class="s2">&quot;my-awesome-username&quot;</span><span class="p">,</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This doesn&#8217;t look very good. First, that extra property doesn&#8217;t make it
easier to read and it takes up more space when serializing and
transmitting the event.</p>
<p>In addition, if you use the value object on a web API, people using the
API will need to wrap the properties in their DTOs in a similarly. What
we would like is to have our serialized event to look like this instead
and still use the value object in our events.</p>
<div class="code json highlight-default"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;Username&quot;</span> <span class="p">:</span> <span class="s2">&quot;my-awesome-username&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>To do this, we use the custom JSON serializer EventFlow has for single
value objects called <code class="docutils literal"><span class="pre">SingleValueObjectConverter</span></code> on our <code class="docutils literal"><span class="pre">Username</span></code>
class like this.</p>
<div class="highlight-c#"><div class="highlight"><pre><span></span>[JsonConverter(typeof(SingleValueObjectConverter))] // Only this line added
public class Username : SingleValueObject&lt;string&gt;
{
  public Username(string value) : base(value)
  {
    if (string.IsNullOrEmpty(value) || value.Length &lt;= 4)
    {
      throw DomainError.With($&quot;Invalid username &#39;{value}&#39;&quot;);
    }
  }
}
</pre></div>
</div>
<p>The JSON converter understands the single value object and will
serialize and deserialize it correctly.</p>
<p>Using this converter also enables to you replace e.g. raw <code class="docutils literal"><span class="pre">string</span></code> and
<code class="docutils literal"><span class="pre">int</span></code> properties with value objects on existing events as they will be
&#8220;JSON compatible&#8221;.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Consider applying this to any classes that inherit from <code class="docutils literal"><span class="pre">Identity&lt;&gt;</span></code>.</p>
</div>
</div>
</div>
<span id="document-DosAndDonts"></span><div class="section" id="do-s-and-don-ts">
<span id="dos-and-donts"></span><h2>Do&#8217;s and don&#8217;ts<a class="headerlink" href="#do-s-and-don-ts" title="Permalink to this headline">¶</a></h2>
<p>Whenever creating an application that uses CQRS+ES there are several
things you need to keep in mind to make it easier and minimize the
potential bugs. This guide will give you some details on typical
problems and how EventFlow can help you minimize the risk.</p>
<div class="section" id="business-rules">
<h3>Business rules<a class="headerlink" href="#business-rules" title="Permalink to this headline">¶</a></h3>
<div class="section" id="specifications">
<h4>Specifications<a class="headerlink" href="#specifications" title="Permalink to this headline">¶</a></h4>
<p><cite>Consider</cite> moving complex business rules to <a class="reference internal" href="index.html#specifications"><span class="std std-ref">specifications</span></a>.
This eases both readability, testability and re-use.</p>
</div>
</div>
<div class="section" id="events">
<h3>Events<a class="headerlink" href="#events" title="Permalink to this headline">¶</a></h3>
<div class="section" id="produce-clean-json">
<h4>Produce clean JSON<a class="headerlink" href="#produce-clean-json" title="Permalink to this headline">¶</a></h4>
<p>Make sure that when your aggregate events are JSON serialized, they
produce clean JSON as it makes it easier to work with and enable you to
easier deserialize the events in the future.</p>
<ul class="simple">
<li>No type information</li>
<li>No hints of value objects (see <a class="reference internal" href="index.html#value-objects"><span class="std std-ref">value objects</span></a>)</li>
</ul>
<p>Here&#8217;s an example of good clean event JSON produced from a create user
event.</p>
<div class="code json highlight-default"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;Username&quot;</span><span class="p">:</span> <span class="s2">&quot;root&quot;</span><span class="p">,</span>
  <span class="s2">&quot;PasswordHash&quot;</span><span class="p">:</span> <span class="s2">&quot;1234567890ABCDEF&quot;</span><span class="p">,</span>
  <span class="s2">&quot;EMail&quot;</span><span class="p">:</span> <span class="s2">&quot;root@example.org&quot;</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="keep-old-event-types">
<h4>Keep old event types<a class="headerlink" href="#keep-old-event-types" title="Permalink to this headline">¶</a></h4>
<p>Keep in mind, that you need to keep the event types in your code for as
long as these events are in the event source, which in most cases are
<em>forever</em> as storage is cheap and information, i.e., your domain events,
are expensive.</p>
<p>However, you should still clean your code, have a look at how you can
<a class="reference internal" href="index.html#event-upgrade"><span class="std std-ref">upgrade and version your events</span></a> for details on
how EventFlow supports you in this.</p>
</div>
<div class="section" id="subscribers-and-out-of-order-events">
<h4>Subscribers and out of order events<a class="headerlink" href="#subscribers-and-out-of-order-events" title="Permalink to this headline">¶</a></h4>
<p>Be very careful if aggregates emits multiple events for a single command,
subscribers will almost certainly
<a class="reference internal" href="index.html#out-of-order-event-subscribers"><span class="std std-ref">receive these out of order</span></a>.</p>
</div>
</div>
</div>
<span id="document-Specifications"></span><div class="section" id="specifications">
<span id="id1"></span><h2>Specifications<a class="headerlink" href="#specifications" title="Permalink to this headline">¶</a></h2>
<p>EventFlow ships with an implementation of the
<a class="reference external" href="https://en.wikipedia.org/wiki/Specification_pattern">specification pattern</a>
which could be used to e.g. make complex business rules easier to read and test.</p>
<p>To use the specification implementation shipped with EventFlow, simply create a
class that inherits from <code class="docutils literal"><span class="pre">Specification&lt;T&gt;</span></code>.</p>
<div class="highlight-c#"><div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">class</span> <span class="nc">BelowFiveSpecification</span> <span class="p">:</span> <span class="n">Specification</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="k">override</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">IsNotSatisfiedBecause</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="m">5</span> <span class="p">&lt;=</span> <span class="n">i</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">yield</span> <span class="k">return</span> <span class="kt">string</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="s">&quot;{0} is not below five&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Note that instead of simply returning a <code class="docutils literal"><span class="pre">bool</span></code> to indicate whether or not the
specification is satisfied, this implementation requires a reason (or reasons)
why <strong>not</strong> the specification is satisfied.</p>
<p>The <code class="docutils literal"><span class="pre">ISpecification&lt;T&gt;</span></code> interface has two methods defined, the traditional
<code class="docutils literal"><span class="pre">IsSatisfiedBy</span></code> and the addition <code class="docutils literal"><span class="pre">WhyIsNotSatisfiedBy</span></code>, which returns an
empty enumerable if the specification was indeed satisfied.</p>
<div class="highlight-c#"><div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">interface</span> <span class="n">ISpecification</span><span class="p">&lt;</span><span class="k">in</span> <span class="n">T</span><span class="p">&gt;</span>
<span class="p">{</span>
    <span class="kt">bool</span> <span class="nf">IsSatisfiedBy</span><span class="p">(</span><span class="n">T</span> <span class="n">obj</span><span class="p">);</span>

    <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">WhyIsNotSatisfiedBy</span><span class="p">(</span><span class="n">T</span> <span class="n">obj</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>As specifications really become powerful when they are combined, EventFlow also
ships with a series of extension methods for the <code class="docutils literal"><span class="pre">ISpecification&lt;T&gt;</span></code> interface
that allows easy combination of implemented specifications.</p>
<div class="highlight-c#"><div class="highlight"><pre><span></span><span class="c1">// Throws a `DomainError` exception if obj doesn&#39;t satisfy the specification</span>
<span class="n">spec</span><span class="p">.</span><span class="n">ThrowDomainErrorIfNotStatisfied</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>

<span class="c1">// Builds a new specification that requires all input specifications to be</span>
<span class="c1">// satified</span>
<span class="kt">var</span> <span class="n">allSpec</span> <span class="p">=</span> <span class="n">specEnumerable</span><span class="p">.</span><span class="n">All</span><span class="p">();</span>

<span class="c1">// Builds a new specification that requires a predefined amount of the</span>
<span class="c1">// input specifications to be satisfied</span>
<span class="kt">var</span> <span class="n">atLeastSpec</span> <span class="p">=</span> <span class="n">specEnumerable</span><span class="p">.</span><span class="n">AtLeast</span><span class="p">(</span><span class="m">4</span><span class="p">);</span>

<span class="c1">// Builds a new specification that requires the two input specifications</span>
<span class="c1">// to be satisfied</span>
<span class="kt">var</span> <span class="n">andSpec</span> <span class="p">=</span> <span class="n">spec1</span><span class="p">.</span><span class="n">And</span><span class="p">(</span><span class="n">spec2</span><span class="p">);</span>

<span class="c1">// Builds a new specification that requires one of the two input</span>
<span class="c1">// specifications to be satisfied</span>
<span class="kt">var</span> <span class="n">orSpec</span> <span class="p">=</span> <span class="n">spec1</span><span class="p">.</span><span class="n">Or</span><span class="p">(</span><span class="n">spec2</span><span class="p">);</span>

<span class="c1">// Builds a new specification that requires the input specification</span>
<span class="c1">// not to be satisfied</span>
<span class="kt">var</span> <span class="n">notSpec</span> <span class="p">=</span> <span class="n">spec</span><span class="p">.</span><span class="n">Not</span><span class="p">();</span>
</pre></div>
</div>
<p>If you need a simple expression to combine with other more complex specifications
you can use the bundled <code class="docutils literal"><span class="pre">ExpressionSpecification&lt;T&gt;</span></code>, which is a specification
wrapper for an expression.</p>
<div class="highlight-c#"><div class="highlight"><pre><span></span><span class="kt">var</span> <span class="n">spec</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ExpressionSpecification</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;(</span><span class="n">i</span> <span class="p">=&gt;</span> <span class="m">1</span> <span class="p">&lt;</span> <span class="n">i</span> <span class="p">&amp;&amp;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">3</span><span class="p">);</span>

<span class="c1">// &#39;str&#39; will contain the value &quot;i =&gt; ((1 &lt; i) &amp;&amp; (i &lt; 3))&quot;</span>
<span class="kt">var</span> <span class="n">str</span> <span class="p">=</span> <span class="n">spec</span><span class="p">.</span><span class="n">ToString</span><span class="p">();</span>
</pre></div>
</div>
<p>If the specification isn&#8217;t satisfied, a string representation of the expression
is returned.</p>
</div>
<span id="document-FAQ"></span><div class="section" id="faq-frequently-asked-questions">
<span id="faq"></span><h2>FAQ - frequently asked questions<a class="headerlink" href="#faq-frequently-asked-questions" title="Permalink to this headline">¶</a></h2>
<div class="section" id="how-can-i-ensure-that-only-specific-users-can-execute-commands">
<h3>How can I ensure that only specific users can execute commands?<a class="headerlink" href="#how-can-i-ensure-that-only-specific-users-can-execute-commands" title="Permalink to this headline">¶</a></h3>
<p>You should implement a <em>decorator</em> for the <code class="docutils literal"><span class="pre">ICommandBus</span></code> that does the
authentication. Have a look at the <a class="reference internal" href="index.html#ioc-decorator"><span class="std std-ref">decorator</span></a> documentation
to see how this can be achieved.</p>
</div>
<div class="section" id="why-isn-t-there-a-global-sequence-number-on-domain-events">
<h3>Why isn&#8217;t there a &#8220;global sequence number&#8221; on domain events?<a class="headerlink" href="#why-isn-t-there-a-global-sequence-number-on-domain-events" title="Permalink to this headline">¶</a></h3>
<p>While this is easy to support in some event stores like MSSQL, it
doesn&#8217;t really make sense from a domain perspective. Greg Young also has
this to say on the subject:</p>
<blockquote>
<div>Order is only assured per a handler within an aggregate root
boundary. There is no assurance of order between handlers or between
aggregates. Trying to provide those things leads to the dark side. &gt;
<a class="reference external" href="https://groups.yahoo.com/neo/groups/domaindrivendesign/conversations/topics/18453">Greg
Young</a></div></blockquote>
</div>
<div class="section" id="why-doesn-t-eventflow-have-a-unit-of-work-concept">
<h3>Why doesn&#8217;t EventFlow have a unit of work concept?<a class="headerlink" href="#why-doesn-t-eventflow-have-a-unit-of-work-concept" title="Permalink to this headline">¶</a></h3>
<p>Short answer, you shouldn&#8217;t need it. But Mike has a way better answer:</p>
<blockquote>
<div>In the Domain, everything flows in one direction: forward. When
something bad happens, a correction is applied. The Domain doesn&#8217;t
care about the database and UoW is very coupled to the db. In my
opinion, it&#8217;s a pattern which is usable only with data access
objects, and in probably 99% of the cases you won&#8217;t be needing it.
As with the Singleton, there are better ways but everything depends
on proper domain design. &gt; <a class="reference external" href="http://blog.sapiensworks.com/post/2014/06/04/Unit-Of-Work-is-the-new-Singleton.aspx/">Mike
Mogosanu</a></div></blockquote>
<p>If your case falls within the 1% case, write an decorator for the
<code class="docutils literal"><span class="pre">ICommandBus</span></code> that starts a transaction, use MSSQL as event store and
make sure your read models are stored in MSSQL as well.</p>
</div>
<div class="section" id="why-are-subscribers-are-receiving-events-out-of-order">
<h3>Why are subscribers are receiving events out of order?<a class="headerlink" href="#why-are-subscribers-are-receiving-events-out-of-order" title="Permalink to this headline">¶</a></h3>
<p>It might be your aggregates are emitting multiple events. Read about
<a class="reference internal" href="index.html#out-of-order-event-subscribers"><span class="std std-ref">subscribers and out of order events</span></a>.</p>
</div>
</div>
</div>
</div>
<div class="section" id="indices-and-tables">
<h1>Indices and tables<a class="headerlink" href="#indices-and-tables" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li><a class="reference internal" href="genindex.html"><span class="std std-ref">Index</span></a></li>
<li><a class="reference internal" href="search.html"><span class="std std-ref">Search Page</span></a></li>
</ul>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015-2017, Rasmus Mikkelsen.
      
        <span class="commit">
          Revision <code>c7b99e2a</code>.
        </span>
      

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-book"> Read the Docs</span>
      v: latest
      <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
      <dl>
        <dt>Versions</dt>
        
          <dd><a href="/en/latest/">latest</a></dd>
        
          <dd><a href="/en/stable/">stable</a></dd>
        
      </dl>
      <dl>
        <dt>Downloads</dt>
        
          <dd><a href="//readthedocs.org/projects/eventflow/downloads/htmlzip/latest/">htmlzip</a></dd>
        
      </dl>
      <dl>
        <dt>On Read the Docs</dt>
          <dd>
            <a href="//readthedocs.org/projects/eventflow/?fromdocs=eventflow">Project Home</a>
          </dd>
          <dd>
            <a href="//readthedocs.org/builds/eventflow/?fromdocs=eventflow">Builds</a>
          </dd>
      </dl>
      <hr/>
      Free document hosting provided by <a href="http://www.readthedocs.org">Read the Docs</a>.

    </div>
  </div>



  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'0.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>

  

  
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>